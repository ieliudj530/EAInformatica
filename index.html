<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empresas EAInformática</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #121212; /* Fondo oscuro */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #f5f5f5; /* Texto claro */
            flex-direction: column;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: #1e1e1e; /* Contenedor más claro que el fondo */
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Estilos del menú de pestañas */
        .tab-menu {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .tab-button {
            background-color: #2a2a2a;
            border: 2px solid #3d3d3d;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #ccc;
            transition: background-color 0.3s, color 0.3s, border 0.3s;
            width: 100%;
            border-radius: 8px; /* Esquinas redondeadas */
            margin-bottom: 10px;
        }

        .tab-button.active {
            color: white;
            background-color: #6a1b9a;
            border: 2px solid #6a1b9a;
        }
        
        .tab-button:last-child {
            margin-bottom: 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-container {
            padding: 20px 0;
            text-align: center;
        }

        h2 {
            color: #6a1b9a; /* Morado oscuro, sigue siendo el color de acento */
            margin-bottom: 25px;
            font-size: 2em;
        }

        h3 {
            color: #8e24aa;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        h4 {
            color: #ab47bc;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ccc;
        }

        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            background-color: #333;
            border: 1px solid #555;
            color: #f5f5f5;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #6a1b9a;
            outline: none;
        }

        .btn-submit {
            background-color: #8e24aa; /* Morado brillante */
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn-submit:hover {
            background-color: #ab47bc; /* Morado un poco más claro */
            transform: translateY(-2px);
        }
        
        .form-message {
            margin-top: 20px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .form-message.success {
            color: #4CAF50;
            opacity: 1;
        }

        .form-message.error {
            color: #f44336;
            opacity: 1;
        }
        
        #results-container {
            margin-top: 20px;
            text-align: left;
        }

        #results-container p {
            margin: 5px 0;
        }

        .result-label {
            font-weight: bold;
            color: #ab47bc; /* Tono morado claro para etiquetas */
        }

        /* Estilos para el detalle de productos */
        .product-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .product-item select, .product-item input[type="number"] {
            margin-right: 10px;
            width: auto;
        }
        .btn-add, .btn-remove {
            background-color: #6a1b9a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            margin-left: 5px;
        }
        .btn-remove {
            background-color: #f44336;
        }
        .btn-add:hover, .btn-remove:hover {
            opacity: 0.8;
        }
        .total-debt-info {
            font-size: 1.2em;
            font-weight: 600;
            color: #f44336;
            border: 2px solid #f44336;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .sale-item.pending {
            border-left: 5px solid #f44336;
            padding-left: 10px;
            background-color: #2a1a1a;
        }
        .sale-item.paid {
            border-left: 5px solid #4CAF50;
            padding-left: 10px;
            background-color: #1a2a1a;
        }
        .btn-pay {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        .sale-details-form {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Nuevos estilos para la tabla de inventario */
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .inventory-table th, .inventory-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #3d3d3d;
        }
        .inventory-table th {
            background-color: #6a1b9a;
            color: white;
            font-weight: 600;
        }
        .inventory-table tr:nth-child(even) {
            background-color: #121212;
        }
        .inventory-table tr:hover {
            background-color: #333;
        }

        /* Estilos para el manual */
        .manual-section {
            margin-bottom: 30px;
        }
        .manual-section h4 {
            color: #ab47bc;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .manual-section p, .manual-section ul {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #ccc;
        }
        .manual-section ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        .manual-section ul li {
            margin-bottom: 5px;
        }
        .manual-section code {
            background-color: #333;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
            color: #fff;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tab-menu" id="tab-menu">
        <button class="tab-button active" id="tab-client" onclick="openTab('clientTab', this)">Registrar Cliente</button>
        <button class="tab-button" id="tab-search" onclick="openTab('searchTab', this)">Buscar Cliente & Ventas</button>
        <button class="tab-button" id="tab-inventory" onclick="openTab('inventoryTab', this)">Inventario</button>
        <button class="tab-button" id="tab-manual" onclick="openTab('manualTab', this)">Manual de Usuario</button>
    </div>

    <div id="clientTab" class="tab-content active">
        <div class="form-container">
            <h2>Registro de Clientes</h2>
            <form id="customerForm">
                <input type="hidden" name="action" value="addClient">
                <div class="form-group">
                    <label for="Nome">Nombre</label>
                    <input type="text" id="Nome" name="Nome" required>
                </div>
                <div class="form-group">
                    <label for="CPF/CNPJ">CPF/CNPJ</label>
                    <input type="text" id="CPF/CNPJ" name="CPF/CNPJ" required>
                </div>
                <div class="form-group">
                    <label for="Email">Email</label>
                    <input type="email" id="Email" name="Email" required>
                </div>
                <div class="form-group">
                    <label for="Fecha">Fecha</label>
                    <input type="date" id="Fecha" name="Fecha" required>
                </div>
                <button type="submit" class="btn-submit">Guardar Cliente</button>
                <p id="form-message" class="form-message"></p>
            </form>
        </div>
    </div>

    <div id="searchTab" class="tab-content">
        <div class="form-container">
            <h2>Buscar Cliente y Registrar Venta</h2>
            <form id="searchForm">
                <div class="form-group" id="search-cpf-container">
                    <label for="search-cpf">Buscar por CPF/CNPJ</label>
                    <input type="text" id="search-cpf" name="CPF/CNPJ" required>
                </div>
                <button type="submit" class="btn-submit">Buscar</button>
                <p id="search-message" class="form-message"></p>
            </form>
            <div id="results-container"></div>
        </div>
    </div>

    <div id="inventoryTab" class="tab-content">
        <div class="form-container">
            <h2>Inventario de Productos</h2>
            <div id="inventory-list">
                <p>Cargando inventario...</p>
            </div>
            
            <div id="add-product-container">
                <h3 style="color: #8e24aa;">Agregar Nuevo Producto</h3>
                <form id="addProductForm">
                    <input type="hidden" name="action" value="addProduct">
                    <div class="form-group">
                        <label for="product-name">Nombre del Producto</label>
                        <input type="text" id="product-name" name="Nombre_del_producto" required>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Precio</label>
                        <input type="number" id="product-price" name="Precio" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-stock">Stock</label>
                        <input type="number" id="product-stock" name="Stock" min="0" required>
                    </div>
                    <button type="submit" class="btn-submit">Agregar Producto</button>
                    <p id="add-product-message" class="form-message"></p>
                </form>
            </div>
        </div>
    </div>

    <div id="manualTab" class="tab-content">
        <div class="form-container">
            <h2>Manual de Usuario</h2>
            <p>Bienvenido al sistema de gestión de clientes, ventas e inventario. Este manual te guiará a través de las funciones principales de la aplicación.</p>

            <div class="manual-section">
                <h3>1. Pestaña "Registrar Cliente"</h3>
                <p>Usa esta sección para añadir nuevos clientes a tu base de datos. Completa todos los campos del formulario y haz clic en el botón.</p>
                <ul>
                    <li><strong>Nombre:</strong> Nombre completo del cliente.</li>
                    <li><strong>CPF/CNPJ:</strong> Número de identificación del cliente (sin puntos ni guiones).</li>
                    <li><strong>Email:</strong> Correo electrónico del cliente.</li>
                    <li><strong>Fecha:</strong> Fecha de registro del cliente.</li>
                </ul>
                <p>Al hacer clic en <strong>"Guardar Cliente"</strong>, la información se guardará en la hoja de cálculo <code>Clientes</code>.</p>
            </div>

            <div class="manual-section">
                <h3>2. Pestaña "Buscar Cliente & Ventas"</h3>
                <p>Esta es la sección central del sistema. Te permite encontrar un cliente, ver su historial de ventas, registrar una nueva venta y registrar pagos.</p>
                <h4>2.1. Buscar Cliente</h4>
                <p>En el campo de búsqueda, introduce el <strong>CPF/CNPJ</strong> del cliente y haz clic en <strong>"Buscar"</strong>. Si el cliente existe, sus datos aparecerán debajo, junto con su historial de ventas y la opción para registrar una nueva.</p>
                <h4>2.2. Registrar Nueva Venta</h4>
                <p>Después de buscar un cliente, usa este formulario para añadir una nueva venta a su historial.</p>
                <ul>
                    <li><strong>Fecha de Venta:</strong> Selecciona la fecha en la que se realizó la venta.</li>
                    <li><strong>Añadir Productos:</strong> Usa el botón `+` para añadir una línea de producto. Selecciona un producto del inventario y la cantidad. El botón `-` elimina la línea.</li>
                    <li><strong>Abono Inicial (opcional):</strong> Si el cliente paga una parte del total, ingresa el monto aquí.</li>
                </ul>
                <p>Al hacer clic en <strong>"Guardar Venta"</strong>, la venta se registrará en la hoja <code>Ventas</code> y se actualizará el stock en la hoja <code>Productos</code>.</p>
                <h4>2.3. Historial de Ventas</h4>
                <p>Aquí verás todas las ventas registradas para el cliente. Cada venta muestra su estado (<strong>"Pagado"</strong> o <strong>"Pendiente"</strong>) y la deuda restante.</p>
                <ul>
                    <li>El botón `+` junto a cada venta muestra la lista de productos que se compraron.</li>
                    <li>Si una venta tiene deuda, aparecerá un botón verde <strong>"Pagar"</strong>. Haz clic en él para registrar un abono a esa deuda.</li>
                </ul>
            </div>

            <div class="manual-section">
                <h3>3. Pestaña "Inventario"</h3>
                <p>Esta sección te permite gestionar tu inventario de productos. En la tabla superior puedes ver todos los productos disponibles, sus precios y el stock actual. El stock se actualiza automáticamente cada vez que se registra una venta.</p>
                <h4>3.1. Agregar Nuevo Producto</h4>
                <p>Utiliza el formulario en la parte inferior para añadir un nuevo producto al inventario. Completa los campos y haz clic en <strong>"Agregar Producto"</strong>.</p>
            </div>
        </div>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbybxe6Iu6rlXzk6_rQLkirk2Vi1couqQ8nFhFh8nSmJ_4bWZarpn5WxVDTLAbKLcMLL/exec'; 

    let allProducts = [];
    let salesProducts = [];

    async function loadApp() {
        try {
            openTab('clientTab', document.getElementById('tab-client'));
            
            const productsResponse = await fetch(scriptURL + '?action=getProducts');
            if (!productsResponse.ok) throw new Error('Error al obtener los productos.');
            allProducts = await productsResponse.json();
            
        } catch (error) {
            console.error("Error al cargar la aplicación:", error);
            alert("Hubo un problema al cargar la aplicación. Por favor, recarga la página. Mensaje: " + error.message);
        }
    }
    
    function openTab(tabName, button) {
        var i, tabContent, tabButtons;
        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
        }
        tabButtons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabButtons.length; i++) {
            tabButtons[i].className = tabButtons[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        if (button) {
            button.className += " active";
        }
        if (tabName === 'inventoryTab') {
            loadInventory();
        }
    }

    async function loadInventory() {
        const inventoryList = document.getElementById('inventory-list');
        inventoryList.innerHTML = '<p>Cargando inventario...</p>';
        try {
            const response = await fetch(scriptURL + '?action=getProducts');
            if (!response.ok) throw new Error('Error al obtener los productos.');
            allProducts = await response.json();
            
            if (allProducts.length > 0) {
                let html = '<table class="inventory-table">';
                html += '<thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th></tr></thead>';
                html += '<tbody>';
                allProducts.forEach(product => {
                    html += `<tr>
                               <td>${product['ID_Producto']}</td>
                               <td>${product['Nombre_del_producto']}</td>
                               <td>R$ ${product.Precio.toFixed(2)}</td>
                               <td>${product.Stock}</td>
                             </tr>`;
                });
                html += '</tbody></table>';
                inventoryList.innerHTML = html;
            } else {
                inventoryList.innerHTML = '<p>No hay productos en el inventario.</p>';
            }
        } catch (error) {
            inventoryList.innerHTML = '<p class="form-message error">Error al cargar el inventario: ' + error.message + '</p>';
        }
    }

    if (document.getElementById('customerForm')) {
      const customerForm = document.getElementById('customerForm');
      const customerMessage = document.getElementById('form-message');
      customerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          customerMessage.textContent = 'Enviando...';
          customerMessage.className = 'form-message';
          try {
              const formData = new FormData(customerForm);
              const response = await fetch(scriptURL, { method: 'POST', body: formData });
              const resultText = await response.text();
              if (response.ok) {
                  if (resultText.includes("Error")) {
                      customerMessage.textContent = resultText;
                      customerMessage.className = 'form-message error';
                  } else {
                      customerMessage.textContent = '¡Cliente registrado con éxito!';
                      customerMessage.className = 'form-message success';
                      customerForm.reset();
                  }
              } else {
                  customerMessage.textContent = 'Error al registrar el cliente.';
                  customerMessage.className = 'form-message error';
              }
          } catch (error) {
              customerMessage.textContent = 'Hubo un problema de conexión.';
              customerMessage.className = 'form-message error';
          }
      });
    }

    const searchForm = document.getElementById('searchForm');
    const searchMessage = document.getElementById('search-message');
    const resultsContainer = document.getElementById('results-container');

    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        resultsContainer.innerHTML = '';
        searchMessage.textContent = 'Buscando...';
        searchMessage.className = 'form-message';
        const searchCpfCnpj = document.getElementById('search-cpf').value;

        try {
            const url = scriptURL + '?action=search&CPF/CNPJ=' + searchCpfCnpj;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data && data.Nome) {
                searchMessage.textContent = 'Cliente encontrado:';
                searchMessage.className = 'form-message success';
                
                let salesHtml = data.sales.length > 0
                    ? `<h4>Historial de Ventas:</h4>
                       <ul>
                           ${data.sales.map(sale => `
                               <li class="sale-item ${sale.estado === 'Pagado' ? 'paid' : 'pending'}">
                                   <p><span class="result-label">ID Venta:</span> ${sale.id} | 
                                   <span class="result-label">Monto Total:</span> R$ ${sale.montoTotal.toFixed(2)} | 
                                   <span class="result-label">Pagado:</span> R$ ${sale.montoPagado.toFixed(2)} | 
                                   <span class="result-label">Deuda:</span> R$ ${sale.deudaRestante.toFixed(2)}</p>
                                   <p><span class="result-label">Fecha:</span> ${new Date(sale.fecha).toLocaleDateString()}
                                   <button onclick="toggleSaleDetails(this)">+</button>
                                   ${sale.estado === 'Pendiente' ? `<button class="btn-pay" onclick="showPaymentForm(${sale.id}, ${sale.deudaRestante})">Pagar</button>` : `<span style="color:#4CAF50; font-weight:bold;">(${sale.estado})</span>`}</p>
                                   
                                   <div class="sale-details" style="display:none;">
                                        <ul>
                                            ${sale.productos.map(p => `<li>${p.nombre} (${p.cantidad} unidad/es)</li>`).join('')}
                                        </ul>
                                   </div>
                               </li>
                           `).join('')}
                       </ul>`
                    : `<p>Este cliente no tiene ventas registradas.</p>`;

                resultsContainer.innerHTML = `
                    <p><span class="result-label">Nombre:</span> ${data.Nome}</p>
                    <p><span class="result-label">CPF/CNPJ:</span> ${data['CPF/CNPJ']}</p>
                    <p><span class="result-label">Email:</span> ${data.Email}</p>
                    <p><span class="result-label">Fecha de Registro:</span> ${new Date(data.Fecha).toLocaleDateString()}</p>
                    <hr>
                    <p class="total-debt-info"><strong>Deuda Total Pendiente: R$ ${data.totalDebt}</strong></p>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="color: #8e24aa;">Registrar Nueva Venta para ${data.Nome}</h3>
                        <form id="saleForm">
                            <input type="hidden" name="action" value="addSale">
                            <input type="hidden" name="CPF/CNPJ" value="${data['CPF/CNPJ']}">
                            <input type="hidden" id="productsJson" name="Productos">
                            <input type="hidden" id="totalAmount" name="MontoTotal">
                            
                            <div class="form-group">
                                <label for="sale-fecha">Fecha de Venta</label>
                                <input type="date" id="sale-fecha" name="Fecha" required>
                            </div>
                            <div id="products-list"></div>
                            <div style="text-align: right;">
                                <button type="button" onclick="addProductField()" class="btn-add">+</button>
                            </div>
                            <div class="form-group" style="margin-top: 20px;">
                                <label for="initialPayment">Abono Inicial (opcional)</label>
                                <input type="number" id="initialPayment" name="Monto_Pagado" step="0.01" min="0">
                            </div>
                            <br>
                            <button type="submit" class="btn-submit">Guardar Venta</button>
                            <p id="sale-message" class="form-message"></p>
                        </form>
                    </div>

                    ${salesHtml}
                `;
                salesProducts = [];
                addProductField();
                const saleForm = document.getElementById('saleForm');
                const saleMessage = document.getElementById('sale-message');
                saleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    saleMessage.textContent = 'Calculando y enviando...';
                    saleMessage.className = 'form-message';
                    
                    let total = 0;
                    const finalProducts = [];
                    salesProducts.forEach(p => {
                        const product = allProducts.find(prod => prod.ID_Producto == p.id);
                        if (product) {
                            total += product.Precio * p.cantidad;
                            finalProducts.push({
                                id: product.ID_Producto,
                                nombre: product.Nombre_del_producto,
                                cantidad: p.cantidad
                            });
                        }
                    });

                    document.getElementById('totalAmount').value = total;
                    document.getElementById('productsJson').value = JSON.stringify(finalProducts);

                    try {
                        const formData = new FormData(saleForm);
                        const response = await fetch(scriptURL, { method: 'POST', body: formData });
                        const resultText = await response.text();
                        if (response.ok) {
                            if (resultText.includes("Error")) {
                                saleMessage.textContent = resultText;
                                saleMessage.className = 'form-message error';
                            } else {
                                saleMessage.textContent = '¡Venta registrada con éxito!';
                                saleMessage.className = 'form-message success';
                                saleForm.reset();
                                salesProducts = [];
                                resultsContainer.innerHTML = '';
                                searchForm.dispatchEvent(new Event('submit'));
                            }
                        } else {
                            saleMessage.textContent = 'Error al registrar la venta.';
                            saleMessage.className = 'form-message error';
                        }
                    } catch (error) {
                        saleMessage.textContent = 'Hubo un problema de conexión.';
                        saleMessage.className = 'form-message error';
                    }
                });
                
            } else {
                searchMessage.textContent = 'No se encontró ningún cliente con ese CPF/CNPJ.';
                searchMessage.className = 'form-message error';
            }
        } catch (error) {
            searchMessage.textContent = 'Hubo un problema en la búsqueda: ' + error.message;
            searchMessage.className = 'form-message error';
        }
    });
    
    async function handlePayment(saleId, paymentAmount) {
        const paymentMessage = document.getElementById(`payment-message-${saleId}`);
        paymentMessage.textContent = 'Registrando pago...';
        paymentMessage.className = 'form-message';
        try {
            const formData = new FormData();
            formData.append('action', 'addPayment');
            formData.append('ID_Transaccion', saleId);
            formData.append('Monto_Pago', paymentAmount);

            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();
            if (response.ok) {
                if (resultText.includes("Error")) {
                    paymentMessage.textContent = resultText;
                    paymentMessage.className = 'form-message error';
                } else {
                    paymentMessage.textContent = '¡Pago registrado con éxito!';
                    paymentMessage.className = 'form-message success';
                    searchForm.dispatchEvent(new Event('submit'));
                }
            } else {
                paymentMessage.textContent = 'Error al registrar el pago.';
                paymentMessage.className = 'form-message error';
            }
        } catch (error) {
            paymentMessage.textContent = 'Hubo un problema de conexión.';
            paymentMessage.className = 'form-message error';
        }
    }

    function showPaymentForm(saleId, currentDebt) {
        const formId = `payment-form-${saleId}`;
        const existingForm = document.getElementById(formId);
        if (existingForm) {
            existingForm.remove();
            return;
        }

        const paymentForm = document.createElement('form');
        paymentForm.id = formId;
        paymentForm.className = 'sale-details-form';
        paymentForm.onsubmit = (e) => {
            e.preventDefault();
            const amountInput = paymentForm.querySelector('input');
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0 || amount > currentDebt) {
                alert(`El monto debe ser un número positivo y no mayor a la deuda restante de R$ ${currentDebt.toFixed(2)}.`);
                return;
            }
            handlePayment(saleId, amount);
        };
        
        paymentForm.innerHTML = `
            <div class="form-group">
                <label for="payment-amount-${saleId}">Monto a pagar (Deuda: R$ ${currentDebt.toFixed(2)})</label>
                <input type="number" id="payment-amount-${saleId}" step="0.01" min="0.01" max="${currentDebt}" required>
            </div>
            <button type="submit" class="btn-submit">Registrar Abono</button>
            <p id="payment-message-${saleId}" class="form-message"></p>
        `;

        const saleItem = document.querySelector(`.sale-item .btn-pay[onclick*="${saleId}"]`).closest('.sale-item');
        saleItem.appendChild(paymentForm);
    }
    
    function addProductField() {
        const productsListDiv = document.getElementById('products-list');
        const index = salesProducts.length;

        const productSelect = document.createElement('select');
        productSelect.innerHTML = allProducts.map(p => 
            `<option value="${p.ID_Producto}" data-price="${p.Precio}">${p.Nombre_del_producto}</option>`
        ).join('');
        productSelect.onchange = (e) => updateProduct(index, e.target.value, salesProducts[index].cantidad);

        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.value = 1;
        quantityInput.min = 1;
        quantityInput.onchange = (e) => updateProduct(index, salesProducts[index].id, parseInt(e.target.value));
        quantityInput.style.width = '80px';
        
        const removeButton = document.createElement('button');
        removeButton.textContent = '-';
        removeButton.type = 'button';
        removeButton.className = 'btn-remove';
        removeButton.onclick = () => removeProductField(index);

        const productItem = document.createElement('div');
        productItem.className = 'product-item';
        productItem.id = `product-item-${index}`;
        productItem.appendChild(productSelect);
        productItem.appendChild(quantityInput);
        productItem.appendChild(removeButton);
        productsListDiv.appendChild(productItem);

        if (allProducts.length > 0) {
            salesProducts.push({
                id: allProducts[0].ID_Producto,
                cantidad: 1
            });
        }
    }

    function updateProduct(index, productId, quantity) {
        salesProducts[index].id = productId;
        salesProducts[index].cantidad = quantity;
    }

    function removeProductField(index) {
        const element = document.getElementById(`product-item-${index}`);
        if (element) {
            element.remove();
        }
        salesProducts.splice(index, 1);

        const productsListDiv = document.getElementById('products-list');
        productsListDiv.innerHTML = '';
        salesProducts.forEach((p, i) => {
            const productSelect = document.createElement('select');
            productSelect.innerHTML = allProducts.map(prod => 
                `<option value="${prod.ID_Producto}" data-price="${prod.Precio}">${prod.Nombre_del_producto}</option>`
            ).join('');
            productSelect.value = p.id;
            productSelect.onchange = (e) => updateProduct(i, e.target.value, salesProducts[i].cantidad);

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.value = p.cantidad;
            quantityInput.min = 1;
            quantityInput.onchange = (e) => updateProduct(i, salesProducts[i].id, parseInt(e.target.value));
            quantityInput.style.width = '80px';
            
            const removeButton = document.createElement('button');
            removeButton.textContent = '-';
            removeButton.type = 'button';
            removeButton.className = 'btn-remove';
            removeButton.onclick = () => removeProductField(i);

            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.id = `product-item-${i}`;
            productItem.appendChild(productSelect);
            productItem.appendChild(quantityInput);
            productItem.appendChild(removeButton);
            productsListDiv.appendChild(productItem);
        });
    }

    function toggleSaleDetails(button) {
        const saleItem = button.closest('.sale-item');
        if (saleItem) {
            const details = saleItem.querySelector('.sale-details');
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        }
    }

    const addProductForm = document.getElementById('addProductForm');
    const addProductMessage = document.getElementById('add-product-message');
    if (addProductForm) {
      addProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        addProductMessage.textContent = 'Agregando producto...';
        addProductMessage.className = 'form-message';
        try {
          const formData = new FormData(addProductForm);
          const response = await fetch(scriptURL, { method: 'POST', body: formData });
          const resultText = await response.text();
          if (response.ok) {
            if (resultText.includes("Error")) {
              addProductMessage.textContent = resultText;
              addProductMessage.className = 'form-message error';
            } else {
              addProductMessage.textContent = '¡Producto agregado con éxito!';
              addProductMessage.className = 'form-message success';
              addProductForm.reset();
              loadInventory();
            }
          } else {
            addProductMessage.textContent = 'Error al agregar el producto.';
            addProductMessage.className = 'form-message error';
          }
        } catch (error) {
          addProductMessage.textContent = 'Hubo un problema de conexión.';
          addProductMessage.className = 'form-message error';
        }
      });
    }
    
    document.addEventListener('DOMContentLoaded', loadApp);

</script>
</body>
</html>