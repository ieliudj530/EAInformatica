<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti칩n de Empresas EAInform치tica</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    /* === PALETA DE COLORES DARK MODE: GRIS, AZUL Y BLANCO === */
    :root {
        --color-fondo: #0d1117; /* Gris oscuro principal (como GitHub) */
        --color-superficie: #161b22; /* Gris un poco m치s claro para contenedores */
        --color-primario: #58a6ff; /* Azul brillante para acentos y botones */
        --color-primario-hover: #79b8ff; /* Azul m치s claro para hover */
        --color-texto-principal: #c9d1d9; /* Blanco/Gris claro para texto principal */
        --color-texto-secundario: #8b949e; /* Gris para etiquetas y texto menos importante */
        --color-texto-inverso: #0d1117; /* Texto oscuro para fondos claros/azules */
        --color-borde: #30363d; /* Borde gris oscuro */
        --color-exito: #3fb950; /* Verde */
        --color-peligro: #f85149; /* Rojo */
        --sombra-suave: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    /* ========================================================== */

    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--color-fondo);
        color: var(--color-texto-principal);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        flex-direction: column;
        padding: 20px;
        position: relative;
    }
    
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(13, 17, 23, 0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        backdrop-filter: blur(5px);
    }

    .loading-logo {
        height: 100px !important;
        animation: pulse 1.5s ease-in-out infinite;
        border-radius: 50%;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 0.7; }
        50% { transform: scale(1.1); opacity: 1; }
        100% { transform: scale(1); opacity: 0.7; }
    }

    .container {
        width: 100%;
        max-width: 900px;
        background-color: var(--color-superficie);
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--sombra-suave);
        border: 1px solid var(--color-borde);
    }

    .tab-menu {
        display: flex;
        flex-direction: row;
        justify-content: center;
        gap: 18px;
        margin-bottom: 30px;
        margin-top: 10px;
    }

    .tab-button {
        background-color: transparent;
        border: 2px solid var(--color-primario);
        padding: 12px 28px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 600;
        color: var(--color-primario);
        transition: background-color 0.3s, color 0.3s;
        border-radius: 8px;
    }

    .tab-button.active {
        background-color: var(--color-primario);
        color: var(--color-texto-inverso);
    }
    
    .tab-button:hover:not(.active) {
        background-color: var(--color-primario);
        color: var(--color-texto-inverso);
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-container { padding: 20px 0; text-align: center; }

    h1 {
        color: var(--color-texto-principal);
        font-size: 2.5em;
        margin-bottom: 0;
    }

    h2 {
        color: var(--color-primario);
        margin-bottom: 25px;
        font-size: 2em;
        text-align: left;
    }

    h3 {
        color: var(--color-texto-principal);
        margin-bottom: 15px;
        font-size: 1.5em;
        text-align: left;
    }

    h4 {
        color: var(--color-texto-secundario);
        margin-bottom: 10px;
        font-size: 1.2em;
        text-align: left;
    }

    .form-group { margin-bottom: 20px; text-align: left; }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--color-texto-secundario);
    }

    input[type="text"],
    input[type="email"],
    input[type="date"],
    input[type="number"],
    select {
        width: 100%;
        padding: 12px;
        background-color: var(--color-fondo);
        border: 1px solid var(--color-borde);
        color: var(--color-texto-principal);
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 1em;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    select:focus {
        border-color: var(--color-primario);
        outline: none;
        box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.25);
    }

    .btn-submit {
        background-color: var(--color-primario);
        color: var(--color-texto-inverso);
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 100%;
        margin-top: 10px;
    }

    .btn-submit:hover {
        background-color: var(--color-primario-hover);
    }
    
    .form-message {
        margin-top: 20px;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        min-height: 20px;
    }

    .form-message.success { color: var(--color-exito); opacity: 1; }
    .form-message.error { color: var(--color-peligro); opacity: 1; }
    
    #results-container { margin-top: 20px; text-align: left; }
    #results-container p { margin: 5px 0; }
    .result-label { font-weight: bold; color: var(--color-texto-secundario); }

    .product-item { display: flex; align-items: center; margin-bottom: 10px; }
    .product-item select, .product-item input[type="number"] { margin-right: 10px; width: auto; }
    
    .btn-add, .btn-remove {
        color: var(--color-texto-inverso);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        width: 35px;
        height: 35px;
        font-size: 1.5em;
        line-height: 35px;
        margin-left: 5px;
        transition: opacity 0.3s;
    }
    .btn-add { background-color: var(--color-exito); }
    .btn-remove { background-color: var(--color-peligro); }
    .btn-add:hover, .btn-remove:hover { opacity: 0.8; }
    
    .total-debt-info {
        font-size: 1.2em;
        font-weight: 600;
        color: var(--color-peligro);
        background-color: rgba(248, 81, 73, 0.1);
        border: 1px solid rgba(248, 81, 73, 0.4);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
    }

    .sale-item {
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid var(--color-borde);
    }
    .sale-item.pending {
        border-left: 5px solid var(--color-primario);
        background-color: var(--color-fondo);
    }
    .sale-item.paid {
        border-left: 5px solid var(--color-exito);
        background-color: var(--color-fondo);
    }
    .btn-pay {
        background-color: var(--color-exito);
        color: var(--color-texto-inverso);
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
        font-weight: 600;
    }
    .sale-details-form {
        background-color: var(--color-fondo);
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
        border: 1px solid var(--color-borde);
    }

    .inventory-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .inventory-table th, .inventory-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--color-borde); }
    .inventory-table th { background-color: #1e242c; color: var(--color-texto-principal); font-weight: 600; }
    .inventory-table tr:hover { background-color: #1e242c; }
    .inventory-table td:last-child { text-align: right; }

    #user-manual-button {
        background-color: var(--color-primario);
        color: var(--color-texto-inverso);
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        z-index: 1000;
        position: fixed;
        top: 20px;
        right: 20px;
        transition: background-color 0.3s;
    }

    #user-manual-button:hover { background-color: var(--color-primario-hover); }

    #user-manual-content {
        position: fixed;
        top: 70px;
        right: 20px;
        background-color: var(--color-superficie);
        color: var(--color-texto-principal);
        border: 1px solid var(--color-borde);
        border-radius: 8px;
        padding: 20px;
        width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 999;
        display: none;
        text-align: left;
        box-shadow: var(--sombra-suave);
    }
    
    #user-manual-content h2, #user-manual-content h3 { color: var(--color-primario); }
    
    .inventory-form-section {
        background-color: var(--color-fondo);
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid var(--color-borde);
    }
    
    .debt-client-header {
        cursor: pointer;
        background-color: var(--color-superficie);
        color: var(--color-texto-principal);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 5px;
        transition: background-color 0.2s, border-color 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--color-borde);
    }
    
    .debt-client-header:hover { background-color: #1e242c; }
    .debt-client-header h4 { margin: 0; color: var(--color-texto-principal); }
    .debt-client-header span { font-weight: 600; color: var(--color-peligro); }
    
    .debt-details {
        display: none;
        padding: 10px 15px;
        margin-bottom: 10px;
        background-color: var(--color-fondo);
        border-left: 3px solid var(--color-primario);
        border-radius: 0 0 8px 8px;
    }

    .dropdown { position: relative; display: inline-block; }
    .dropbtn { background-color: transparent; color: var(--color-texto-secundario); padding: 8px; font-size: 20px; border: none; cursor: pointer; }
    .dropdown-content {
        display: none;
        position: absolute;
        background-color: var(--color-superficie);
        min-width: 120px;
        box-shadow: var(--sombra-suave);
        z-index: 1;
        right: 0;
        border-radius: 5px;
        border: 1px solid var(--color-borde);
        overflow: hidden;
    }
    .dropdown-content a { color: var(--color-texto-principal); padding: 12px 16px; text-decoration: none; display: block; text-align: left; font-size: 0.9em; }
    .dropdown-content a:hover { background-color: var(--color-primario); color: var(--color-texto-inverso); }
    .dropdown:hover .dropdown-content { display: block; }
    
    div[style*="position:fixed"][style*="left:20px"] img {
        height: 100px !important;
        border-radius: 50%;
    }
    /* === C칍DIGO PARA RESPONSIVIDAD (CELULARES) === */
@media (max-width: 768px) {

    body {
        padding: 10px; /* Menos espacio en los bordes de la pantalla */
    }

    .container {
        padding: 15px; /* Menos padding en el contenedor principal */
    }

    /* 1. Hacemos que los botones del men칰 se apilen verticalmente */
    .tab-menu {
        flex-direction: column;
        gap: 10px;
        align-items: center; /* Centramos los botones */
    }

    .tab-button {
        width: 100%; /* Para que ocupen todo el ancho disponible */
        text-align: center;
    }

    /* 2. Ajustamos la ventana del manual para que quepa */
    #user-manual-content {
        width: 90%;
        max-width: 400px; /* No ser치 m치s grande que 400px, pero s칤 m치s peque침o si es necesario */
        top: 15px;
        right: 5%; /* Centramos un poco m치s */
        left: 5%;
        max-height: 80vh;
    }

    /* 3. Para que la tabla de inventario no rompa el dise침o, permitimos scroll horizontal */
    .inventory-table {
        display: block; /* Necesario para que overflow-x funcione */
        width: 100%;
        overflow-x: auto; /* 춰Magia! Permite deslizar la tabla hacia los lados */
        white-space: nowrap; /* Evita que el texto de las celdas se parta */
    }

    /* 4. Ajustamos tama침os de texto y logos para pantallas peque침as */
    h1 {
        font-size: 1.8em;
    }

    h2 {
        font-size: 1.4em;
    }

    div[style*="position:fixed"][style*="left:20px"] img {
        height: 60px !important; /* Hacemos el logo de la esquina un poco m치s peque침o */
    }
}
/* A침ade esto al final de tu <style> en index.html */
.debt-container {
    margin-bottom: 10px;
}

.debt-client-header h4 span {
    color: var(--color-texto-secundario);
    font-size: 0.9em;
    font-weight: 400;
}

.total-debt-amount {
    font-weight: 600;
    color: var(--color-peligro);
}

.client-sales-container {
    padding-left: 20px;
    border-left: 2px solid var(--color-borde);
    margin-top: 5px;
    display: none;
}

.sale-debt-item {
    margin: 5px 0;
}

.sale-debt-header {
    background-color: var(--color-fondo);
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    transition: background-color 0.2s;
    border: 1px solid var(--color-borde);
}

.sale-debt-header:hover {
    background-color: #1e242c;
}

.sale-products-container {
    padding: 10px 10px 10px 30px;
    background-color: var(--color-fondo);
    border-radius: 0 0 5px 5px;
    display: none;
}
.sale-products-container ul {
    margin: 0;
    padding-left: 20px;
}

.total-general-debt {
    text-align: right;
    font-size: 1.4em;
    font-weight: 600;
    color: var(--color-primario);
    margin-top: 20px;
    padding: 10px;
    background-color: var(--color-superficie);
    border-radius: 8px;
}
/* ESTILOS PARA PAGINACI칍N */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 20px;
    gap: 15px;
}
.pagination button {
    background-color: var(--color-primario);
    color: var(--color-texto-inverso);
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
}
.pagination button:disabled {
    background-color: var(--color-borde);
    cursor: not-allowed;
}
.pagination span {
    color: var(--color-texto-secundario);
    font-weight: 600;
}
</style>
</head>
<body>
    <div id="loading-overlay">
        <img src="Logotipo.png" alt="Cargando..." class="loading-logo" style="border-radius: 50%;">
    </div>

    <div style="position:fixed; top:20px; left:20px; z-index:1100;">
        <img src="Logotipo.png" alt="Logo EAInform치tica" style="height:100px; border-radius: 50%;">
    </div>
    <div id="user-manual-button" onclick="toggleManual()">Manual de Usuario</div>

<div id="user-manual-content">
    <h2>Manual de Usuario</h2>
    <p>Bienvenido a <strong>EAInform치tica Gesti칩n</strong>, una herramienta integral para gestionar clientes, ventas, inventario y cuentas por cobrar. Este sistema fue dise침ado para peque침as empresas que desean llevar un control digital y eficiente de sus operaciones sin depender de software costoso.</p>

    <div class="manual-section">
        <h3>Requisitos T칠cnicos</h3>
        <ul>
            <li>Navegador actualizado (Google Chrome recomendado).</li>
            <li>Conexi칩n a internet estable.</li>
            <li>Acceso autorizado al sistema (URL personalizada).</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>1. Registrar Cliente</h3>
        <p>Completa todos los campos del formulario y haz clic en <strong>"Guardar Cliente"</strong>. La informaci칩n se guarda en la hoja <code>Clientes</code>.</p>
        <ul>
            <li><strong>Nombre:</strong> Nombre completo.</li>
            <li><strong>CPF/CNPJ:</strong> Identificaci칩n fiscal (sin puntos ni guiones).</li>
            <li><strong>Email:</strong> Correo electr칩nico v치lido.</li>
            <li><strong>Tel칠fono/Direcci칩n:</strong> Opcionales pero recomendados.</li>
            <li><strong>Fecha:</strong> Fecha del registro.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>2. Buscar Cliente & Registrar Venta</h3>
        <h4>2.1 Buscar Cliente</h4>
        <p>Introduce el <strong>CPF/CNPJ</strong> y presiona <strong>Buscar</strong>. Si el cliente existe, ver치s sus datos y ventas.</p>

        <h4>2.2 Registrar Venta</h4>
        <p>Agrega productos con el bot칩n <code>+</code>. Selecciona producto y cantidad. Puedes ingresar un <strong>abono inicial</strong>. Presiona <strong>Guardar Venta</strong>. Se actualiza autom치ticamente el stock.</p>

        <h4>2.3 Ver Ventas y Pagar</h4>
        <ul>
            <li>Historial muestra ventas con estado <strong>Pagado</strong> o <strong>Pendiente</strong>.</li>
            <li>Haz clic en <code>+</code> para ver productos vendidos.</li>
            <li>Si hay deuda, haz clic en <strong>Pagar</strong> para abonar.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>3. Inventario de Productos</h3>
        <p>Visualiza todos los productos con su precio y stock. El inventario est치 ordenado por ID.</p>

        <h4>3.1 Agregar Producto</h4>
        <ul>
            <li>Si el producto <strong>es nuevo</strong>, completa nombre, precio y stock. El sistema no permite agregar productos con nombres duplicados.</li>
        </ul>

        <h4>3.2 Editar o Eliminar</h4>
        <ul>
            <li>Usa el men칰 <code>...</code> junto al producto.</li>
            <li>"Editar" permite modificar nombre, precio y a침adir o quitar stock.</li>
            <li>"Borrar" elimina el producto permanentemente.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>4. Cuentas por Cobrar</h3>
        <p>Muestra todos los clientes con ventas pendientes. Haz clic en el nombre del cliente para ver detalles de las deudas.</p>

        <ul>
            <li>Visualiza <strong>total adeudado</strong> y detalle por venta.</li>
            <li>Te permite dar seguimiento y contactar clientes f치cilmente.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>5. Preguntas Frecuentes (FAQ)</h3>
        <ul>
            <li><strong>쯈u칠 pasa si ingreso mal un dato?</strong> Puedes editar clientes o productos desde la hoja de c치lculo.</li>
            <li><strong>쯉e guarda autom치ticamente?</strong> S칤, cada acci칩n actualiza las hojas correspondientes.</li>
            <li><strong>쯇uedo usarlo en celular?</strong> S칤, es 100% responsive y funciona en dispositivos m칩viles.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>Soporte T칠cnico</h3>
        <p>쯊ienes preguntas o necesitas ayuda?</p>
        <ul>
            <li><strong>WhatsApp:</strong> <a href="https://wa.me/5549991839170" target="_blank">+55 49 99183-9170</a></li>
            <li><strong>Email:</strong> <a href="mailto:aeinformatica7@gmail.com">aeinformatica7@gmail.com</a></li>
        </ul>
        <p>Con gusto te atender칠. 游땕</p>
    </div>
</div>


<div class="container">
    <div style="text-align:center; margin-bottom:10px; margin-top:10px;">
    <h1 style="color:#00d8ff; font-size:2.5em; margin-bottom:0;">EAInform치tica</h1>
    <p style="color:#0077ff; font-size:1.2em; margin-top:5px; font-weight:500;">Trabajamos con Inteligencia</p>
</div>
    <div class="tab-menu" id="tab-menu">
        <button class="tab-button" id="tab-client" onclick="openTab('clientTab', this)">Registrar Cliente</button>
        <button class="tab-button" id="tab-search" onclick="openTab('searchTab', this)">Buscar Cliente & Ventas</button>
        <button class="tab-button" id="tab-inventory" onclick="openTab('inventoryTab', this)">Inventario</button>
        <button class="tab-button" id="tab-debt" onclick="openTab('debtTab', this)">Cuentas por Cobrar</button>
    </div>

    <div id="clientTab" class="tab-content">
        <div class="form-container">
            <h2>Registro de Clientes</h2>
            <form id="customerForm">
                <input type="hidden" name="action" value="addClient">
                <div class="form-group">
                    <label for="Nome">Nombre</label>
                    <input type="text" id="Nome" name="Nome" required>
                </div>
                <div class="form-group">
                    <label for="CPF/CNPJ">CPF/CNPJ</label>
                    <input type="text" id="CPF/CNPJ" name="CPF/CNPJ" required>
                </div>
                <div class="form-group">
                    <label for="Email">Email</label>
                    <input type="email" id="Email" name="Email" required>
                </div>
                <div class="form-group">
                    <label for="Telefono">Tel칠fono</label>
                    <input type="text" id="Telefono" name="Telefono">
                </div>
                <div class="form-group">
                    <label for="Direccion">Direcci칩n</label>
                    <input type="text" id="Direccion" name="Direccion">
                </div>
                <button type="submit" class="btn-submit">Guardar Cliente</button>
                <p id="form-message" class="form-message"></p>
            </form>
        </div>
    </div>

    <div id="searchTab" class="tab-content">
        <div class="form-container">
            <h2>Buscar Cliente y Registrar Venta</h2>
            <form id="searchForm">
                <div class="form-group" id="search-cpf-container">
                    <label for="search-cpf">Buscar por CPF/CNPJ</label>
                    <input type="text" id="search-cpf" name="CPF/CNPJ" required>
                </div>
                <button type="submit" class="btn-submit">Buscar</button>
                <p id="search-message" class="form-message"></p>
            </form>
            <div id="results-container"></div>
        </div>
    </div>

   <div id="inventoryTab" class="tab-content">
        <div class="form-container">
            <h2>Inventario de Productos</h2>
            <div id="inventory-list">
                </div>
            
            <div id="inventory-pagination" class="pagination"></div> 
            
            <div class="inventory-form-section" id="addProductSection">
                <form id="addProductForm">
                    <input type="hidden" name="action" value="addProduct">
                    <h3>Agregar Nuevo Producto</h3>
                    <div class="form-group">
                        <label for="product-name">Nombre del Producto</label>
                        <input type="text" id="product-name" name="Nombre_del_producto" required>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Precio</label>
                        <input type="number" id="product-price" name="Precio" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-stock">Stock Inicial</label>
                        <input type="number" id="product-stock" name="Stock" min="0" required>
                    </div>
                    <button type="submit" class="btn-submit">Agregar Producto</button>
                    <p id="add-product-message" class="form-message"></p>
                </form>
            </div>
            
            <div class="inventory-form-section" id="editProductSection" style="display:none;">
                <form id="editProductForm">
                    <h3>Editar Producto</h3>
                    <input type="hidden" id="edit-product-id">
                    <div class="form-group">
                        <label for="edit-product-name">Nombre del Producto</label>
                        <input type="text" id="edit-product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-price">Precio</label>
                        <input type="number" id="edit-product-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-stock-amount">Cantidad a Modificar (ej: 10 para agregar, -5 para quitar)</label>
                        <input type="number" id="edit-stock-amount" required placeholder="Introduce un n칰mero positivo">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn-add" style="width: 50%;" onclick="handleStockUpdate('add')">Agregar Stock</button>
                        <button type="button" class="btn-remove" style="width: 50%;" onclick="handleStockUpdate('subtract')">Quitar Stock</button>
                    </div>
                    <button type="button" class="btn-submit" style="background-color: var(--color-texto-secundario); margin-top: 10px;" onclick="cancelEdit()">Cancelar</button>
                    <p id="edit-product-message" class="form-message"></p>
                </form>
            </div>
        </div>
    </div>

    <div id="debtTab" class="tab-content">
        <div class="form-container">
            <h2>Cuentas por Cobrar</h2>
            <div id="debt-list">
                <p>Cargando cuentas pendientes...</p>
            </div>
        </div>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbybxe6Iu6rlXzk6_rQLkirk2Vi1couqQ8nFhFh8nSmJ_4bWZarpn5WxVDTLAbKLcMLL/exec'; 

    let allProducts = [];
    let salesProducts = [];
    let currentPage = 1;
    const productsPerPage = 10;

    // *** NUEVO: Listener para el bot칩n "Atr치s" del navegador ***
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.tab) {
            // Llama a openTab pero sin agregar un nuevo estado al historial
            openTab(event.state.tab, document.querySelector(`.tab-button[onclick*="'${event.state.tab}'"]`), true);
        } else {
            // Si el estado es nulo, vuelve a la pesta침a inicial por defecto
            openTab('clientTab', document.getElementById('tab-client'), true);
        }
    });

    function showLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }

    async function loadApp(initialTab = 'clientTab') {
        try {
            const tabButton = document.querySelector(`.tab-button[onclick*="'${initialTab}'"]`);
            openTab(initialTab, tabButton, true);
            await fetchProducts();
        } catch (error) {
            console.error("Error al cargar la aplicaci칩n:", error);
            alert("Hubo un problema al cargar la aplicaci칩n. Por favor, recarga la p치gina. Mensaje: " + error.message);
        }
    }

    async function fetchProducts() {
        showLoading();
        try {
            const productsResponse = await fetch(scriptURL + '?action=getProducts');
            if (!productsResponse.ok) throw new Error('Error al obtener los productos.');
            allProducts = await productsResponse.json();
            
            // *** CAMBIO: Ordenar productos por ID_Producto num칠ricamente ***
            allProducts.sort((a, b) => a['ID_Producto'] - b['ID_Producto']);

        } catch (error) {
            console.error("Error al cargar los productos:", error);
            allProducts = [];
        } finally {
            hideLoading();
        }
    }
    
    // *** MODIFICADO: Ahora maneja el historial del navegador ***
    function openTab(tabName, button, fromHistory = false) {
        // Oculta todos los contenidos de las pesta침as
        const tabContents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].style.display = "none";
        }

        // Quita la clase 'active' de todos los botones
        const tabButtons = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tabButtons.length; i++) {
            tabButtons[i].className = tabButtons[i].className.replace(" active", "");
        }

        // Muestra el contenido de la pesta침a actual y activa el bot칩n
        document.getElementById(tabName).style.display = "block";
        if (button) {
            button.className += " active";
        }

        // Si la navegaci칩n no viene del historial (es un clic del usuario), lo agregamos
        if (!fromHistory) {
            history.pushState({ tab: tabName }, '', `#${tabName}`);
        }

        // Acciones espec칤ficas por pesta침a
        if (tabName === 'inventoryTab') {
            currentPage = 1;
            loadInventory();
            cancelEdit();
        } else if (tabName === 'debtTab') {
            loadPendingSales();
        } else if (tabName === 'searchTab') {
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('search-message').textContent = '';
        } else if (tabName === 'clientTab') {
            document.getElementById('form-message').textContent = '';
        }
    }

    async function loadInventory() {
        const inventoryList = document.getElementById('inventory-list');
        inventoryList.innerHTML = '<p>Cargando inventario...</p>';
        
        if (allProducts.length === 0) {
            await fetchProducts();
        }

        if (allProducts.length > 0) {
            const startIndex = (currentPage - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            const paginatedProducts = allProducts.slice(startIndex, endIndex);

            let html = '<table class="inventory-table">';
            html += '<thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th></th></tr></thead>';
            html += '<tbody>';
            paginatedProducts.forEach(product => {
                const stockColor = product.Stock <= 5 ? 'style="color: var(--color-peligro); font-weight: bold;"' : '';
                html += `<tr>
                           <td>${product['ID_Producto']}</td>
                           <td>${product['Nombre_del_producto']}</td>
                           <td>R$ ${product.Precio.toFixed(2)}</td>
                           <td ${stockColor}>${product.Stock}</td>
                           <td>
                                <div class="dropdown">
                                    <button class="dropbtn">...</button>
                                    <div class="dropdown-content">
                                        <a href="#" onclick="editProduct('${product['ID_Producto']}')">Editar</a>
                                        <a href="#" onclick="deleteProduct('${product['ID_Producto']}')">Borrar</a>
                                    </div>
                                </div>
                           </td>
                         </tr>`;
            });
            html += '</tbody></table>';
            inventoryList.innerHTML = html;

            renderPaginationControls();
        } else {
            inventoryList.innerHTML = '<p>No hay productos en el inventario.</p>';
            document.getElementById('inventory-pagination').innerHTML = '';
        }
    }

    function renderPaginationControls() {
        const paginationContainer = document.getElementById('inventory-pagination');
        const totalPages = Math.ceil(allProducts.length / productsPerPage);

        if (totalPages <= 1) {
            paginationContainer.innerHTML = '';
            return;
        }

        let html = `
            <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo; Anterior</button>
            <span>P치gina ${currentPage} de ${totalPages}</span>
            <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>Siguiente &raquo;</button>
        `;
        paginationContainer.innerHTML = html;
    }

    function changePage(direction) {
        const totalPages = Math.ceil(allProducts.length / productsPerPage);
        currentPage += direction;
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        loadInventory();
    }

    function editProduct(id) {
        const product = allProducts.find(p => p['ID_Producto'] == id);
        if (!product) return;

        document.getElementById('addProductSection').style.display = 'none';
        document.getElementById('editProductSection').style.display = 'block';
        
        document.getElementById('edit-product-id').value = product['ID_Producto'];
        document.getElementById('edit-product-name').value = product['Nombre_del_producto'];
        document.getElementById('edit-product-price').value = product.Precio;
        document.getElementById('edit-stock-amount').value = '';
        document.getElementById('edit-product-message').textContent = '';
        window.scrollTo(0, document.body.scrollHeight);
    }
    
    function cancelEdit() {
        document.getElementById('editProductForm').reset();
        document.getElementById('addProductSection').style.display = 'block';
        document.getElementById('editProductSection').style.display = 'none';
    }
    
    async function deleteProduct(id) {
        if (!confirm('쮼st치s seguro de que quieres borrar este producto? Esta acci칩n es irreversible.')) {
            return;
        }
        
        showLoading();
        try {
            const formData = new FormData();
            formData.append('action', 'deleteProduct');
            formData.append('ID_Producto', id);
            
            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();
            
            if (response.ok && !resultText.includes("Error")) {
                alert('Producto eliminado con 칠xito.');
                await fetchProducts();
                loadInventory();
            } else {
                alert(resultText || 'Error al procesar la solicitud.');
            }
        } catch (error) {
            alert('Hubo un problema de conexi칩n.');
        } finally {
            hideLoading();
        }
    }

    async function loadPendingSales() {
        const debtList = document.getElementById('debt-list');
        debtList.innerHTML = '<p>Cargando cuentas pendientes...</p>';
        showLoading();
        try {
            const response = await fetch(scriptURL + '?action=getPendingSales');
            const groupedSales = await response.json();
            
            if (groupedSales.length > 0) {
                let totalGeneralDebt = 0;
                let html = '<h3>Deuda Total por Cliente</h3>';
                
                // Ordenar clientes por nombre
                groupedSales.sort((a,b) => a.nombreCliente.localeCompare(b.nombreCliente));

                groupedSales.forEach((client, clientIndex) => {
                    totalGeneralDebt += client.deudaTotal; 

                    html += `
                        <div class="debt-container">
                            <div class="debt-client-header" onclick="toggleVisibility('client-sales-${clientIndex}')">
                                <h4>${client.nombreCliente} <span>(ID: ${client.id} | CPF/CNPJ: ${client.cpfCnpj})</span></h4>
                                <span class="total-debt-amount">Deuda: R$ ${client.deudaTotal.toFixed(2)}</span>
                            </div>
                            
                            <div class="client-sales-container" id="client-sales-${clientIndex}">
                                ${client.ventas.map((sale, saleIndex) => `
                                    <div class="sale-debt-item">
                                        <div class="sale-debt-header" onclick="toggleVisibility('sale-products-${clientIndex}-${saleIndex}')">
                                            <span>ID Venta: ${sale.id} | Deuda: R$ ${sale.deudaRestante.toFixed(2)} | Fecha: ${new Date(sale.fecha).toLocaleDateString()}</span>
                                            <button class="btn-pay" onclick="event.stopPropagation(); showUniversalPaymentForm(event, ${sale.id}, ${sale.deudaRestante}, 'debt-list')">Abonar</button>
                                        </div>
                                        <div class="sale-products-container" id="sale-products-${clientIndex}-${saleIndex}">
                                            <ul>${sale.productos.map(p => `<li>${p.cantidad}x ${p.nombre}</li>`).join('')}</ul>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                html += `<hr><div class="total-general-debt">Deuda Total General: R$ ${totalGeneralDebt.toFixed(2)}</div>`;
                debtList.innerHTML = html;
            } else {
                debtList.innerHTML = '<p>No hay cuentas pendientes en este momento.</p>';
            }
        } catch (error) {
            console.error("Error al cargar las cuentas pendientes:", error);
            debtList.innerHTML = '<p>Error al cargar las cuentas pendientes.</p>';
        } finally {
            hideLoading();
        }
    }
    
    function toggleVisibility(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.display = element.style.display === 'block' ? 'none' : 'block';
        }
    }

    const customerForm = document.getElementById('customerForm');
    customerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const customerMessage = document.getElementById('form-message');
        customerMessage.textContent = 'Enviando...';
        customerMessage.className = 'form-message';
        showLoading();
        try {
            const formData = new FormData(customerForm);
            formData.append('Fecha', new Date().toISOString());
            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();
            
            if (response.ok && !resultText.includes("Error")) {
                customerMessage.textContent = '춰Cliente registrado con 칠xito!';
                customerMessage.className = 'form-message success';
                customerForm.reset();
            } else {
                customerMessage.textContent = resultText || 'Error al registrar el cliente.';
                customerMessage.className = 'form-message error';
            }
        } catch (error) {
            customerMessage.textContent = 'Hubo un problema de conexi칩n.';
            customerMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
    });

    const searchForm = document.getElementById('searchForm');
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const resultsContainer = document.getElementById('results-container');
        const searchMessage = document.getElementById('search-message');
        
        resultsContainer.innerHTML = '';
        searchMessage.textContent = 'Buscando...';
        searchMessage.className = 'form-message';
        showLoading();
        const searchCpfCnpj = document.getElementById('search-cpf').value;

        try {
            const url = `${scriptURL}?action=search&CPF/CNPJ=${encodeURIComponent(searchCpfCnpj)}`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data && data.Nome) {
                searchMessage.textContent = 'Cliente encontrado:';
                searchMessage.className = 'form-message success';
                
                let salesHtml = data.sales.length > 0
                    ? `<h4>Historial de Ventas:</h4>
                       <ul>
                           ${data.sales.map(sale => `
                               <li class="sale-item ${sale.estado === 'Pagado' ? 'paid' : 'pending'}">
                                   <p><span class="result-label">ID Venta:</span> ${sale.id} | 
                                   <span class="result-label">Monto Total:</span> R$ ${sale.montoTotal.toFixed(2)} | 
                                   <span class="result-label">Pagado:</span> R$ ${sale.montoPagado.toFixed(2)} | 
                                   <span class="result-label">Deuda:</span> R$ ${sale.deudaRestante.toFixed(2)}</p>
                                   <p><span class="result-label">Fecha:</span> ${new Date(sale.fecha).toLocaleDateString()}
                                   <button onclick="toggleSaleDetails(this)">+</button>
                                   ${sale.estado === 'Pendiente' ? `<button class="btn-pay" onclick="showUniversalPaymentForm(event, ${sale.id}, ${sale.deudaRestante}, 'results-container')">Pagar</button>` : `<span style="color:var(--color-exito); font-weight:bold;">(${sale.estado})</span>`}</p>
                                   
                                   <div class="sale-details" style="display:none;">
                                        <ul>
                                            ${sale.productos.map(p => `<li>${p.cantidad}x ${p.nombre}</li>`).join('')}
                                        </ul>
                                   </div>
                               </li>
                           `).join('')}
                       </ul>`
                    : `<p>Este cliente no tiene ventas registradas.</p>`;

                resultsContainer.innerHTML = `
                    <p><span class="result-label">Nombre:</span> ${data.Nome}</p>
                    <p><span class="result-label">CPF/CNPJ:</span> ${data['CPF/CNPJ']}</p>
                    <p><span class="result-label">Email:</span> ${data.Email}</p>
                    <p><span class="result-label">Tel칠fono:</span> ${data.Telefono || 'N/A'}</p>
                    <p><span class="result-label">Direcci칩n:</span> ${data.Direccion || 'N/A'}</p>
                    <p><span class="result-label">Fecha de Registro:</span> ${new Date(data.Fecha).toLocaleDateString()}</p>
                    <hr>
                    <p class="total-debt-info"><strong>Deuda Total Pendiente: R$ ${data.totalDebt.toFixed(2)}</strong></p>
                    
                    <div id="payment-form-container"></div>

                    <div style="margin-top: 20px;">
                        <h3 style="color: var(--color-primario);">Registrar Nueva Venta para ${data.Nome}</h3>
                        <form id="saleForm">
                            <input type="hidden" name="action" value="addSale">
                            <input type="hidden" name="CPF/CNPJ" value="${data['CPF/CNPJ']}">
                            <input type="hidden" id="productsJson" name="Productos">
                            <input type="hidden" id="totalAmount" name="MontoTotal">
                            
                            <div id="products-list"></div>
                            <div style="text-align: right;">
                                <button type="button" onclick="addProductField()" class="btn-add">+</button>
                            </div>
                            <div class="form-group" style="margin-top: 20px;">
                                <label for="initialPayment">Abono Inicial (opcional)</label>
                                <input type="number" id="initialPayment" name="Monto_Pagado" step="0.01" min="0">
                            </div>
                            <br>
                            <button type="submit" class="btn-submit">Guardar Venta</button>
                            <p id="sale-message" class="form-message"></p>
                        </form>
                    </div>

                    ${salesHtml}
                `;
                salesProducts = [];
                addProductField();
                
                const saleForm = document.getElementById('saleForm');
                saleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const saleMessage = document.getElementById('sale-message');
                    saleMessage.textContent = 'Calculando y enviando...';
                    saleMessage.className = 'form-message';
                    showLoading();
                    
                    let total = 0;
                    const finalProducts = [];
                    salesProducts.forEach(p => {
                        const product = allProducts.find(prod => prod.ID_Producto == p.id);
                        if (product) {
                            total += product.Precio * p.cantidad;
                            finalProducts.push({
                                id: product.ID_Producto,
                                nombre: product.Nombre_del_producto,
                                cantidad: p.cantidad
                            });
                        }
                    });

                    document.getElementById('totalAmount').value = total;
                    document.getElementById('productsJson').value = JSON.stringify(finalProducts);

                    try {
                        const formData = new FormData(saleForm);
                        formData.append('Fecha', new Date().toISOString());
                        const response = await fetch(scriptURL, { method: 'POST', body: formData });
                        const resultText = await response.text();
                        
                        if (response.ok && !resultText.includes("Error")) {
                            saleMessage.textContent = '춰Venta registrada con 칠xito!';
                            saleMessage.className = 'form-message success';
                            await fetchProducts(); // Actualizar stock
                            searchForm.dispatchEvent(new Event('submit')); // Recargar cliente
                        } else {
                            saleMessage.textContent = resultText || 'Error al registrar la venta.';
                            saleMessage.className = 'form-message error';
                        }
                    } catch (error) {
                        saleMessage.textContent = 'Hubo un problema de conexi칩n.';
                        saleMessage.className = 'form-message error';
                    } finally {
                        hideLoading();
                    }
                });
                
            } else {
                searchMessage.textContent = 'No se encontr칩 ning칰n cliente con ese CPF/CNPJ.';
                searchMessage.className = 'form-message error';
            }
        } catch (error) {
            searchMessage.textContent = 'Hubo un problema en la b칰squeda: ' + error.message;
            searchMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
    });

    function showUniversalPaymentForm(event, saleId, currentDebt, containerId) {
        // C칩digo de depuraci칩n para la consola (F12)
        console.log(`Funci칩n showUniversalPaymentForm llamada. ID de Venta: ${saleId}, Contenedor: ${containerId}`);

        const formId = `payment-form-${saleId}`;
        
        const existingForms = document.querySelectorAll('.universal-payment-form');
        existingForms.forEach(form => form.remove());

        let paymentFormContainer;
        if (containerId === 'debt-list') {
            paymentFormContainer = event.target.closest('.sale-debt-item');
        } else {
            paymentFormContainer = document.getElementById('payment-form-container');
        }

        if (!paymentFormContainer) {
            console.error("Error: No se encontr칩 el contenedor para el formulario de pago.");
            return;
        }
        
        const paymentForm = document.createElement('div'); 
        paymentForm.id = formId;
        paymentForm.className = 'sale-details-form universal-payment-form'; 
        paymentForm.innerHTML = `
            <form onsubmit="event.preventDefault(); handleUniversalPayment(${saleId}, ${currentDebt}, '${containerId}');">
                <div class="form-group">
                    <label for="payment-amount-${saleId}">Monto a abonar (Deuda: R$ ${currentDebt.toFixed(2)})</label>
                    <input type="number" id="payment-amount-${saleId}" step="0.01" min="0.01" max="${currentDebt}" required>
                </div>
                <button type="submit" class="btn-submit">Registrar Abono</button>
                <button type="button" class="btn-submit" style="background-color: var(--color-texto-secundario); margin-top: 10px;" onclick="this.closest('.universal-payment-form').remove()">Cancelar</button>
                <p id="payment-message-${saleId}" class="form-message"></p>
            </form>
        `;
        
        if (containerId === 'debt-list') {
             paymentFormContainer.appendChild(paymentForm);
        } else {
            paymentFormContainer.prepend(paymentForm);
        }
    }

    async function handleUniversalPayment(saleId, currentDebt, containerId) {
        const paymentForm = document.getElementById(`payment-form-${saleId}`);
        const amountInput = paymentForm.querySelector('input');
        const paymentMessage = paymentForm.querySelector('p');
        let amount = parseFloat(amountInput.value);

        if (isNaN(amount) || amount <= 0) {
            alert(`El monto debe ser un n칰mero positivo.`);
            return;
        }

        if (amount > currentDebt && Math.abs(amount - currentDebt) > 0.01) {
            alert(`El monto del pago es mayor que la deuda restante de R$ ${currentDebt.toFixed(2)}.`);
            return;
        }
        
        if (Math.abs(amount - currentDebt) < 0.01) {
            amount = currentDebt;
        }

        paymentMessage.textContent = 'Registrando pago...';
        paymentMessage.className = 'form-message';
        showLoading();

        try {
            const formData = new FormData();
            formData.append('action', 'addPayment');
            formData.append('ID_Transaccion', saleId);
            formData.append('Monto_Pago', amount);

            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();

            if (response.ok && !resultText.includes("Error")) {
                alert('춰Pago registrado con 칠xito!');
                if (containerId === 'debt-list') {
                    loadPendingSales();
                } else {
                    document.getElementById('searchForm').dispatchEvent(new Event('submit'));
                }
            } else {
                alert(resultText || 'Error al registrar el pago.');
            }
        } catch (error) {
            alert('Hubo un problema de conexi칩n.');
        } finally {
            hideLoading();
        }
    }

    function addProductField() {
        const productsListDiv = document.getElementById('products-list');
        if (!productsListDiv) return;
        const index = salesProducts.length;

        const productItem = document.createElement('div');
        productItem.className = 'product-item';
        productItem.id = `product-item-${index}`;
        
        const availableProducts = allProducts.filter(p => p.Stock > 0);
        if (availableProducts.length === 0 && salesProducts.length === 0) {
             productItem.innerHTML = '<p>No hay productos con stock disponible.</p>';
             productsListDiv.appendChild(productItem);
             return;
        }

        const productSelect = document.createElement('select');
        productSelect.innerHTML = availableProducts
            .map(p => `<option value="${p.ID_Producto}">${p.Nombre_del_producto} (Stock: ${p.Stock})</option>`)
            .join('');
        productSelect.onchange = (e) => updateProduct(index, e.target.value, salesProducts[index].cantidad);

        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.value = 1;
        quantityInput.min = 1;
        quantityInput.oninput = (e) => updateProduct(index, salesProducts[index].id, parseInt(e.target.value));
        quantityInput.style.width = '80px';
        
        const removeButton = document.createElement('button');
        removeButton.textContent = '-';
        removeButton.type = 'button';
        removeButton.className = 'btn-remove';
        removeButton.onclick = () => removeProductField(index);

        productItem.appendChild(productSelect);
        productItem.appendChild(quantityInput);
        productItem.appendChild(removeButton);
        productsListDiv.appendChild(productItem);

        const selectedProduct = allProducts.find(p => p.ID_Producto == productSelect.value);
        if (selectedProduct) {
            salesProducts.push({ id: selectedProduct.ID_Producto, cantidad: 1 });
            quantityInput.max = selectedProduct.Stock;
        } else if (availableProducts.length > 0) {
            salesProducts.push({ id: availableProducts[0].ID_Producto, cantidad: 1 });
            quantityInput.max = availableProducts[0].Stock;
        }
    }

    function updateProduct(index, productId, quantity) {
        salesProducts[index].id = productId;
        salesProducts[index].cantidad = quantity || 1;
        
        const product = allProducts.find(p => p.ID_Producto == productId);
        const productItem = document.getElementById(`product-item-${index}`);
        if(product && productItem) {
            const quantityInput = productItem.querySelector('input[type="number"]');
            quantityInput.max = product.Stock;
            if (quantity > product.Stock) {
                quantityInput.value = product.Stock;
                salesProducts[index].cantidad = product.Stock;
            }
        }
    }

    function removeProductField(index) {
        salesProducts.splice(index, 1);
        const productsListDiv = document.getElementById('products-list');
        productsListDiv.innerHTML = '';
        const tempSalesProducts = [...salesProducts];
        salesProducts = [];
        tempSalesProducts.forEach(p => {
             addProductField();
             const newIndex = salesProducts.length - 1;
             const newItem = document.getElementById(`product-item-${newIndex}`);
             newItem.querySelector('select').value = p.id;
             newItem.querySelector('input').value = p.cantidad;
             updateProduct(newIndex, p.id, p.cantidad);
        });
    }

    function toggleSaleDetails(button) {
        const saleItem = button.closest('.sale-item');
        if (saleItem) {
            const details = saleItem.querySelector('.sale-details');
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        }
    }

    const addProductForm = document.getElementById('addProductForm');
    addProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const addProductMessage = document.getElementById('add-product-message');
        addProductMessage.textContent = 'Enviando...';
        addProductMessage.className = 'form-message';
        showLoading();
        
        try {
            const formData = new FormData(addProductForm);
            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();

            if (response.ok && !resultText.includes("Error")) {
                addProductMessage.textContent = '춰Operaci칩n exitosa!';
                addProductMessage.className = 'form-message success';
                addProductForm.reset();
                await fetchProducts(); // Actualiza la lista de productos
                loadInventory();     // Recarga la vista del inventario
            } else {
                addProductMessage.textContent = resultText || 'Error al procesar la solicitud.';
                addProductMessage.className = 'form-message error';
            }
        } catch (error) {
            addProductMessage.textContent = 'Hubo un problema de conexi칩n.';
            addProductMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
    });
    
    async function handleStockUpdate(operation) {
        const editProductMessage = document.getElementById('edit-product-message');
        const productId = document.getElementById('edit-product-id').value;
        const productName = document.getElementById('edit-product-name').value;
        const productPrice = document.getElementById('edit-product-price').value;
        let stockAmount = parseInt(document.getElementById('edit-stock-amount').value);

        if (isNaN(stockAmount) || stockAmount <= 0) {
            alert('Por favor, introduce una cantidad positiva v치lida para modificar el stock.');
            return;
        }

        if (operation === 'subtract') {
            stockAmount = -stockAmount; // Convierte el n칰mero a negativo para restar
        }

        editProductMessage.textContent = 'Actualizando...';
        editProductMessage.className = 'form-message';
        showLoading();

        const formData = new FormData();
        formData.append('action', 'updateProduct');
        formData.append('ID_Producto', productId);
        formData.append('Nombre_del_producto', productName);
        formData.append('Precio', productPrice);
        formData.append('Stock', stockAmount);

        try {
            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();

            if (response.ok && !resultText.includes("Error")) {
                editProductMessage.textContent = '춰Producto actualizado con 칠xito!';
                editProductMessage.className = 'form-message success';
                await fetchProducts();
                loadInventory();
                cancelEdit();
            } else {
                editProductMessage.textContent = resultText;
                editProductMessage.className = 'form-message error';
            }
        } catch (error) {
            editProductMessage.textContent = 'Hubo un problema de conexi칩n.';
            editProductMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
    }

    function toggleManual() {
        const manualContent = document.getElementById('user-manual-content');
        if (manualContent.style.display === 'block') {
            manualContent.style.display = 'none';
        } else {
            manualContent.style.display = 'block';
        }
    }
    
    // *** MODIFICADO: Ahora maneja el historial al cargar la p치gina ***
    document.addEventListener('DOMContentLoaded', () => {
        // Determina la pesta침a inicial desde la URL o usa la de cliente por defecto
        const initialTab = window.location.hash ? window.location.hash.substring(1) : 'clientTab';
        // Establece el estado inicial en el historial sin crear una nueva entrada
        history.replaceState({ tab: initialTab }, '', `#${initialTab}`);
        // Carga la aplicaci칩n con la pesta침a inicial
        loadApp(initialTab);
    });

</script>
</body>
</html>