<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empresas EAInformática</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f0f5; /* Gris claro */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            flex-direction: column;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* Estilos del menú de pestañas */
        .tab-menu {
            display: flex;
            justify-content: space-around;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #555;
            transition: color 0.3s, border-bottom 0.3s;
        }

        .tab-button.active {
            color: #6a1b9a;
            border-bottom: 3px solid #6a1b9a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-container {
            padding: 20px 0;
            text-align: center;
        }

        h2 {
            color: #6a1b9a; /* Morado oscuro */
            margin-bottom: 25px;
            font-size: 2em;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #6a1b9a;
            outline: none;
        }

        .btn-submit {
            background-color: #8e24aa; /* Morado brillante */
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn-submit:hover {
            background-color: #ab47bc; /* Morado un poco más claro */
            transform: translateY(-2px);
        }
        
        .form-message {
            margin-top: 20px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .form-message.success {
            color: #4CAF50;
            opacity: 1;
        }

        .form-message.error {
            color: #f44336;
            opacity: 1;
        }
        
        #results-container {
            margin-top: 20px;
            text-align: left;
        }

        #results-container p {
            margin: 5px 0;
        }

        .result-label {
            font-weight: bold;
            color: #6a1b9a;
        }

        /* Estilos para el detalle de productos */
        .product-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .product-item select, .product-item input[type="number"] {
            margin-right: 10px;
            width: auto;
        }
        .btn-add, .btn-remove {
            background-color: #6a1b9a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            margin-left: 5px;
        }
        .btn-remove {
            background-color: #f44336;
        }
        .btn-add:hover, .btn-remove:hover {
            opacity: 0.8;
        }
        .total-debt-info {
            font-size: 1.2em;
            font-weight: 600;
            color: #f44336;
            border: 2px solid #f44336;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .sale-item.pending {
            border-left: 5px solid #f44336;
            padding-left: 10px;
        }
        .sale-item.paid {
            border-left: 5px solid #4CAF50;
            padding-left: 10px;
        }
        .btn-pay {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        .sale-details-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Nuevos estilos para la tabla de inventario */
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .inventory-table th, .inventory-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .inventory-table th {
            background-color: #6a1b9a;
            color: white;
            font-weight: 600;
        }
        .inventory-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .inventory-table tr:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tab-menu" id="tab-menu">
        <button class="tab-button" id="tab-client" onclick="openTab('clientTab')">Registrar Cliente</button>
        <button class="tab-button" id="tab-search" onclick="openTab('searchTab')">Buscar Cliente & Ventas</button>
        <button class="tab-button" id="tab-inventory" onclick="openTab('inventoryTab')">Inventario</button>
    </div>

    <div id="clientTab" class="tab-content">
        <div class="form-container">
            <h2>Registro de Clientes</h2>
            <form id="customerForm">
                <input type="hidden" name="action" value="addClient">
                <div class="form-group">
                    <label for="Nome">Nombre</label>
                    <input type="text" id="Nome" name="Nome" required>
                </div>
                <div class="form-group">
                    <label for="CPF/CNPJ">CPF/CNPJ</label>
                    <input type="text" id="CPF/CNPJ" name="CPF/CNPJ" required>
                </div>
                <div class="form-group">
                    <label for="Email">Email</label>
                    <input type="email" id="Email" name="Email" required>
                </div>
                <div class="form-group">
                    <label for="Fecha">Fecha</label>
                    <input type="date" id="Fecha" name="Fecha" required>
                </div>
                <button type="submit" class="btn-submit">Guardar Cliente</button>
                <p id="form-message" class="form-message"></p>
            </form>
        </div>
    </div>

    <div id="searchTab" class="tab-content">
        <div class="form-container">
            <h2>Buscar Cliente y Registrar Venta</h2>
            <form id="searchForm">
                <div class="form-group" id="search-cpf-container">
                    <label for="search-cpf">Buscar por CPF/CNPJ</label>
                    <input type="text" id="search-cpf" name="CPF/CNPJ" required>
                </div>
                <button type="submit" class="btn-submit">Buscar</button>
                <p id="search-message" class="form-message"></p>
            </form>
            <div id="results-container"></div>
        </div>
    </div>

    <div id="inventoryTab" class="tab-content">
        <div class="form-container">
            <h2>Inventario de Productos</h2>
            <div id="inventory-list">
                <p>Cargando inventario...</p>
            </div>
            
            <div id="add-product-container" style="display:none;">
                <h3 style="color: #8e24aa;">Agregar Nuevo Producto</h3>
                <form id="addProductForm">
                    <input type="hidden" name="action" value="addProduct">
                    <div class="form-group">
                        <label for="product-name">Nombre del Producto</label>
                        <input type="text" id="product-name" name="Nombre_del_producto" required>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Precio</label>
                        <input type="number" id="product-price" name="Precio" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-stock">Stock</label>
                        <input type="number" id="product-stock" name="Stock" min="0" required>
                    </div>
                    <button type="submit" class="btn-submit">Agregar Producto</button>
                    <p id="add-product-message" class="form-message"></p>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbybxe6Iu6rlXzk6_rQLkirk2Vi1couqQ8nFhFh8nSmJ_4bWZarpn5WxVDTLAbKLcMLL/exec'; 

    let allProducts = [];
    let salesProducts = [];
    let userRole = null;

    async function loadApp() {
        try {
            const roleResponse = await fetch(scriptURL + '?action=getRole');
            const roleData = await roleResponse.json();
            userRole = roleData.role;

            const tabClient = document.getElementById('tab-client');
            const clientTab = document.getElementById('clientTab');
            const tabSearch = document.getElementById('tab-search');
            const tabInventory = document.getElementById('tab-inventory');
            const searchCpfContainer = document.getElementById('search-cpf-container');
            const addProductContainer = document.getElementById('add-product-container');

            if (userRole === 'admin') {
                tabClient.style.display = 'block';
                clientTab.style.display = 'block';
                tabClient.classList.add('active');
                
                tabSearch.style.display = 'block';
                tabInventory.style.display = 'block';
                searchCpfContainer.style.display = 'block';
                addProductContainer.style.display = 'block';

            } else { // cliente o rol desconocido
                tabClient.style.display = 'none';
                clientTab.style.display = 'none';
                
                tabSearch.style.display = 'block';
                tabInventory.style.display = 'block';
                searchCpfContainer.style.display = 'none';
                addProductContainer.style.display = 'none';
                
                document.getElementById('searchTab').style.display = 'block';
                tabSearch.classList.add('active');

                // Si el usuario es un cliente, ejecuta la búsqueda automáticamente
                searchForm.dispatchEvent(new Event('submit'));
            }

            // Cargar productos para el registro de ventas y la tabla de inventario
            const productsResponse = await fetch(scriptURL + '?action=getProducts');
            allProducts = await productsResponse.json();
            
        } catch (error) {
            console.error("Error al cargar la aplicación:", error);
            alert("Hubo un problema al cargar la aplicación. Por favor, recarga la página.");
        }
    }
    
    function openTab(tabName) {
        var i, tabContent, tabButtons;
        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
        }
        tabButtons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabButtons.length; i++) {
            tabButtons[i].className = tabButtons[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        event.currentTarget.className += " active";
        if (tabName === 'inventoryTab') {
            loadInventory();
        }
    }

    async function loadInventory() {
        const inventoryList = document.getElementById('inventory-list');
        inventoryList.innerHTML = '<p>Cargando inventario...</p>';
        try {
            const response = await fetch(scriptURL + '?action=getProducts');
            allProducts = await response.json();
            
            if (allProducts.length > 0) {
                let html = '<table class="inventory-table">';
                html += '<thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th></tr></thead>';
                html += '<tbody>';
                allProducts.forEach(product => {
                    html += `<tr>
                               <td>${product['ID_Producto']}</td>
                               <td>${product['Nombre_del_producto']}</td>
                               <td>R$ ${product.Precio.toFixed(2)}</td>
                               <td>${product.Stock}</td>
                             </tr>`;
                });
                html += '</tbody></table>';
                inventoryList.innerHTML = html;
            } else {
                inventoryList.innerHTML = '<p>No hay productos en el inventario.</p>';
            }
        } catch (error) {
            inventoryList.innerHTML = '<p class="form-message error">Error al cargar el inventario.</p>';
        }
    }

    // Lógica para el formulario de registro de cliente (solo admins)
    if (userRole === 'admin') {
      const customerForm = document.getElementById('customerForm');
      const customerMessage = document.getElementById('form-message');
      customerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          customerMessage.textContent = 'Enviando...';
          customerMessage.className = 'form-message';
          try {
              const formData = new FormData(customerForm);
              const response = await fetch(scriptURL, { method: 'POST', body: formData });
              const resultText = await response.text();
              if (response.ok) {
                  if (resultText.includes("Error")) {
                      customerMessage.textContent = resultText;
                      customerMessage.className = 'form-message error';
                  } else {
                      customerMessage.textContent = '¡Cliente registrado con éxito!';
                      customerMessage.className = 'form-message success';
                      customerForm.reset();
                  }
              } else {
                  customerMessage.textContent = 'Error al registrar el cliente.';
                  customerMessage.className = 'form-message error';
              }
          } catch (error) {
              customerMessage.textContent = 'Hubo un problema de conexión.';
              customerMessage.className = 'form-message error';
          }
      });
    }

    // Lógica para el formulario de búsqueda (para admins y clientes)
    const searchForm = document.getElementById('searchForm');
    const searchMessage = document.getElementById('search-message');
    const resultsContainer = document.getElementById('results-container');

    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        resultsContainer.innerHTML = '';
        searchMessage.textContent = 'Buscando...';
        searchMessage.className = 'form-message';
        const searchCpfCnpj = document.getElementById('search-cpf').value;
        try {
            const url = userRole === 'admin' ? 
                scriptURL + '?action=search&CPF/CNPJ=' + searchCpfCnpj : 
                scriptURL + '?action=search'; // El Apps Script usará el CPF del usuario autenticado
            const response = await fetch(url);
            const data = await response.json();
            if (data && data.Nome) {
                searchMessage.textContent = 'Cliente encontrado:';
                searchMessage.className = 'form-message success';
                
                let salesHtml = data.sales.length > 0
                    ? `<h4>Historial de Ventas:</h4>
                       <ul>
                           ${data.sales.map(sale => `
                               <li class="sale-item ${sale.estado === 'Pagado' ? 'paid' : 'pending'}">
                                   <p><span class="result-label">ID Venta:</span> ${sale.id} | 
                                   <span class="result-label">Monto Total:</span> R$ ${sale.montoTotal.toFixed(2)} | 
                                   <span class="result-label">Pagado:</span> R$ ${sale.montoPagado.toFixed(2)} | 
                                   <span class="result-label">Deuda:</span> R$ ${sale.deudaRestante.toFixed(2)}</p>
                                   <p><span class="result-label">Fecha:</span> ${new Date(sale.fecha).toLocaleDateString()}
                                   <button onclick="toggleSaleDetails(this)">+</button>
                                   ${sale.estado === 'Pendiente' && userRole === 'admin' ? `<button class="btn-pay" onclick="showPaymentForm(${sale.id}, ${sale.deudaRestante})">Pagar</button>` : `<span style="color:#4CAF50; font-weight:bold;">(${sale.estado})</span>`}</p>
                                   
                                   <div class="sale-details" style="display:none;">
                                        <ul>
                                            ${sale.productos.map(p => `<li>${p.nombre} (${p.cantidad} unidad/es)</li>`).join('')}
                                        </ul>
                                   </div>
                               </li>
                           `).join('')}
                       </ul>`
                    : `<p>Este cliente no tiene ventas registradas.</p>`;

                resultsContainer.innerHTML = `
                    <p><span class="result-label">Nombre:</span> ${data.Nome}</p>
                    <p><span class="result-label">CPF/CNPJ:</span> ${data['CPF/CNPJ']}</p>
                    <p><span class="result-label">Email:</span> ${data.Email}</p>
                    <p><span class="result-label">Fecha de Registro:</span> ${new Date(data.Fecha).toLocaleDateString()}</p>
                    <hr>
                    <p class="total-debt-info"><strong>Deuda Total Pendiente: R$ ${data.totalDebt}</strong></p>
                    
                    ${userRole === 'admin' ? 
                    `<div style="margin-top: 20px;">
                        <h3 style="color: #8e24aa;">Registrar Nueva Venta para ${data.Nome}</h3>
                        <form id="saleForm">
                            <input type="hidden" name="action" value="addSale">
                            <input type="hidden" name="CPF/CNPJ" value="${data['CPF/CNPJ']}">
                            <input type="hidden" id="productsJson" name="Productos">
                            <input type="hidden" id="totalAmount" name="MontoTotal">
                            
                            <div class="form-group">
                                <label for="sale-fecha">Fecha de Venta</label>
                                <input type="date" id="sale-fecha" name="Fecha" required>
                            </div>
                            <div id="products-list"></div>
                            <div style="text-align: right;">
                                <button type="button" onclick="addProductField()" class="btn-add">+</button>
                            </div>
                            <div class="form-group" style="margin-top: 20px;">
                                <label for="initialPayment">Abono Inicial (opcional)</label>
                                <input type="number" id="initialPayment" name="Monto_Pagado" step="0.01" min="0">
                            </div>
                            <br>
                            <button type="submit" class="btn-submit">Guardar Venta</button>
                            <p id="sale-message" class="form-message"></p>
                        </form>
                    </div>` : ''}

                    ${salesHtml}
                `;
                salesProducts = [];
                if (userRole === 'admin') {
                    addProductField();
                    const saleForm = document.getElementById('saleForm');
                    const saleMessage = document.getElementById('sale-message');
                    saleForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        saleMessage.textContent = 'Calculando y enviando...';
                        saleMessage.className = 'form-message';
                        
                        let total = 0;
                        const finalProducts = [];
                        salesProducts.forEach(p => {
                            const product = allProducts.find(prod => prod.ID_Producto == p.id);
                            if (product) {
                                total += product.Precio * p.cantidad;
                                finalProducts.push({
                                    id: product.ID_Producto,
                                    nombre: product.Nombre_del_producto,
                                    cantidad: p.cantidad
                                });
                            }
                        });

                        document.getElementById('totalAmount').value = total;
                        document.getElementById('productsJson').value = JSON.stringify(finalProducts);

                        try {
                            const formData = new FormData(saleForm);
                            const response = await fetch(scriptURL, { method: 'POST', body: formData });
                            const resultText = await response.text();
                            if (response.ok) {
                                if (resultText.includes("Error")) {
                                    saleMessage.textContent = resultText;
                                    saleMessage.className = 'form-message error';
                                } else {
                                    saleMessage.textContent = '¡Venta registrada con éxito!';
                                    saleMessage.className = 'form-message success';
                                    saleForm.reset();
                                    salesProducts = [];
                                    resultsContainer.innerHTML = '';
                                    searchForm.dispatchEvent(new Event('submit'));
                                }
                            } else {
                                saleMessage.textContent = 'Error al registrar la venta.';
                                saleMessage.className = 'form-message error';
                            }
                        } catch (error) {
                            saleMessage.textContent = 'Hubo un problema de conexión.';
                            saleMessage.className = 'form-message error';
                        }
                    });
                }
                
            } else {
                searchMessage.textContent = 'No se encontró ningún cliente con ese CPF/CNPJ.';
                searchMessage.className = 'form-message error';
            }
        } catch (error) {
            searchMessage.textContent = 'Hubo un problema en la búsqueda.';
            searchMessage.className = 'form-message error';
        }
    });
    
    async function handlePayment(saleId, paymentAmount) {
        const paymentMessage = document.getElementById(`payment-message-${saleId}`);
        paymentMessage.textContent = 'Registrando pago...';
        paymentMessage.className = 'form-message';
        try {
            const formData = new FormData();
            formData.append('action', 'addPayment');
            formData.append('ID_Transaccion', saleId);
            formData.append('Monto_Pago', paymentAmount);

            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();
            if (response.ok) {
                if (resultText.includes("Error")) {
                    paymentMessage.textContent = resultText;
                    paymentMessage.className = 'form-message error';
                } else {
                    paymentMessage.textContent = '¡Pago registrado con éxito!';
                    paymentMessage.className = 'form-message success';
                    searchForm.dispatchEvent(new Event('submit'));
                }
            } else {
                paymentMessage.textContent = 'Error al registrar el pago.';
                paymentMessage.className = 'form-message error';
            }
        } catch (error) {
            paymentMessage.textContent = 'Hubo un problema de conexión.';
            paymentMessage.className = 'form-message error';
        }
    }

    function showPaymentForm(saleId, currentDebt) {
        const formId = `payment-form-${saleId}`;
        const existingForm = document.getElementById(formId);
        if (existingForm) {
            existingForm.remove();
            return;
        }

        const paymentForm = document.createElement('form');
        paymentForm.id = formId;
        paymentForm.className = 'sale-details-form';
        paymentForm.onsubmit = (e) => {
            e.preventDefault();
            const amountInput = paymentForm.querySelector('input');
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0 || amount > currentDebt) {
                alert(`El monto debe ser un número positivo y no mayor a la deuda restante de R$ ${currentDebt.toFixed(2)}.`);
                return;
            }
            handlePayment(saleId, amount);
        };
        
        paymentForm.innerHTML = `
            <div class="form-group">
                <label for="payment-amount-${saleId}">Monto a pagar (Deuda: R$ ${currentDebt.toFixed(2)})</label>
                <input type="number" id="payment-amount-${saleId}" step="0.01" min="0.01" max="${currentDebt}" required>
            </div>
            <button type="submit" class="btn-submit">Registrar Abono</button>
            <p id="payment-message-${saleId}" class="form-message"></p>
        `;

        const saleItem = document.querySelector(`.sale-item .btn-pay[onclick*="${saleId}"]`).closest('.sale-item');
        saleItem.appendChild(paymentForm);
    }
    
    function addProductField() {
        const productsListDiv = document.getElementById('products-list');
        const index = salesProducts.length;

        const productSelect = document.createElement('select');
        productSelect.innerHTML = allProducts.map(p => 
            `<option value="${p.ID_Producto}" data-price="${p.Precio}">${p.Nombre_del_producto}</option>`
        ).join('');
        productSelect.onchange = (e) => updateProduct(index, e.target.value, salesProducts[index].cantidad);

        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.value = 1;
        quantityInput.min = 1;
        quantityInput.onchange = (e) => updateProduct(index, salesProducts[index].id, parseInt(e.target.value));
        quantityInput.style.width = '80px';
        
        const removeButton = document.createElement('button');
        removeButton.textContent = '-';
        removeButton.type = 'button';
        removeButton.className = 'btn-remove';
        removeButton.onclick = () => removeProductField(index);

        const productItem = document.createElement('div');
        productItem.className = 'product-item';
        productItem.id = `product-item-${index}`;
        productItem.appendChild(productSelect);
        productItem.appendChild(quantityInput);
        productItem.appendChild(removeButton);
        productsListDiv.appendChild(productItem);

        if (allProducts.length > 0) {
            salesProducts.push({
                id: allProducts[0].ID_Producto,
                cantidad: 1
            });
        }
    }

    function updateProduct(index, productId, quantity) {
        salesProducts[index].id = productId;
        salesProducts[index].cantidad = quantity;
    }

    function removeProductField(index) {
        const element = document.getElementById(`product-item-${index}`);
        if (element) {
            element.remove();
        }
        salesProducts.splice(index, 1);

        const productsListDiv = document.getElementById('products-list');
        productsListDiv.innerHTML = '';
        salesProducts.forEach((p, i) => {
            const productSelect = document.createElement('select');
            productSelect.innerHTML = allProducts.map(prod => 
                `<option value="${prod.ID_Producto}" data-price="${prod.Precio}">${prod.Nombre_del_producto}</option>`
            ).join('');
            productSelect.value = p.id;
            productSelect.onchange = (e) => updateProduct(i, e.target.value, salesProducts[i].cantidad);

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.value = p.cantidad;
            quantityInput.min = 1;
            quantityInput.onchange = (e) => updateProduct(i, salesProducts[i].id, parseInt(e.target.value));
            quantityInput.style.width = '80px';
            
            const removeButton = document.createElement('button');
            removeButton.textContent = '-';
            removeButton.type = 'button';
            removeButton.className = 'btn-remove';
            removeButton.onclick = () => removeProductField(i);

            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.id = `product-item-${i}`;
            productItem.appendChild(productSelect);
            productItem.appendChild(quantityInput);
            productItem.appendChild(removeButton);
            productsListDiv.appendChild(productItem);
        });
    }

    function toggleSaleDetails(button) {
        const details = button.nextElementSibling.nextElementSibling;
        details.style.display = details.style.display === 'none' ? 'block' : 'none';
    }

    // Lógica para el formulario de agregar producto (solo admins)
    const addProductForm = document.getElementById('addProductForm');
    const addProductMessage = document.getElementById('add-product-message');
    if (addProductForm) {
      addProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        addProductMessage.textContent = 'Agregando producto...';
        addProductMessage.className = 'form-message';
        try {
          const formData = new FormData(addProductForm);
          const response = await fetch(scriptURL, { method: 'POST', body: formData });
          const resultText = await response.text();
          if (response.ok) {
            if (resultText.includes("Error")) {
              addProductMessage.textContent = resultText;
              addProductMessage.className = 'form-message error';
            } else {
              addProductMessage.textContent = '¡Producto agregado con éxito!';
              addProductMessage.className = 'form-message success';
              addProductForm.reset();
              loadInventory(); // Recargar el inventario para ver el nuevo producto
            }
          } else {
            addProductMessage.textContent = 'Error al agregar el producto.';
            addProductMessage.className = 'form-message error';
          }
        } catch (error) {
          addProductMessage.textContent = 'Hubo un problema de conexión.';
          addProductMessage.className = 'form-message error';
        }
      });
    }
    
    // Ejecutar al cargar la página
    document.addEventListener('DOMContentLoaded', loadApp);

</script>
</body>
</html>