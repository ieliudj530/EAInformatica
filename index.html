<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empresas EAInformática</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    /* === PALETA DE COLORES DARK MODE: GRIS, AZUL Y BLANCO === */
    :root {
        --color-fondo: #0d1117; /* Gris oscuro principal (como GitHub) */
        --color-superficie: #161b22; /* Gris un poco más claro para contenedores */
        --color-primario: #58a6ff; /* Azul brillante para acentos y botones */
        --color-primario-hover: #79b8ff; /* Azul más claro para hover */
        --color-texto-principal: #c9d1d9; /* Blanco/Gris claro para texto principal */
        --color-texto-secundario: #8b949e; /* Gris para etiquetas y texto menos importante */
        --color-texto-inverso: #0d1117; /* Texto oscuro para fondos claros/azules */
        --color-borde: #30363d; /* Borde gris oscuro */
        --color-exito: #3fb950; /* Verde */
        --color-peligro: #f85149; /* Rojo */
        --sombra-suave: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    /* ========================================================== */

    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--color-fondo);
        color: var(--color-texto-principal);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        flex-direction: column;
        padding: 20px;
        position: relative;
    }
    
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(13, 17, 23, 0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        backdrop-filter: blur(5px);
    }

    .loading-logo {
        height: 100px !important;
        animation: pulse 1.5s ease-in-out infinite;
        border-radius: 50%;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 0.7; }
        50% { transform: scale(1.1); opacity: 1; }
        100% { transform: scale(1); opacity: 0.7; }
    }

    .container {
        width: 100%;
        max-width: 900px;
        background-color: var(--color-superficie);
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--sombra-suave);
        border: 1px solid var(--color-borde);
    }

    .tab-menu {
        display: flex;
        flex-direction: row;
        justify-content: center;
        gap: 18px;
        margin-bottom: 30px;
        margin-top: 10px;
    }

    .tab-button {
        background-color: transparent;
        border: 2px solid var(--color-primario);
        padding: 12px 28px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 600;
        color: var(--color-primario);
        transition: background-color 0.3s, color 0.3s;
        border-radius: 8px;
    }

    .tab-button.active {
        background-color: var(--color-primario);
        color: var(--color-texto-inverso);
    }
    
    .tab-button:hover:not(.active) {
        background-color: var(--color-primario);
        color: var(--color-texto-inverso);
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-container { padding: 20px 0; text-align: center; }

    h1 {
        color: var(--color-texto-principal);
        font-size: 2.5em;
        margin-bottom: 0;
    }

    h2 {
        color: var(--color-primario);
        margin-bottom: 25px;
        font-size: 2em;
        text-align: left;
    }

    h3 {
        color: var(--color-texto-principal);
        margin-bottom: 15px;
        font-size: 1.5em;
        text-align: left;
    }

    h4 {
        color: var(--color-texto-secundario);
        margin-bottom: 10px;
        font-size: 1.2em;
        text-align: left;
    }

    .form-group { margin-bottom: 20px; text-align: left; }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--color-texto-secundario);
    }

    input[type="text"],
    input[type="email"],
    input[type="date"],
    input[type="number"],
    select {
        width: 100%;
        padding: 12px;
        background-color: var(--color-fondo);
        border: 1px solid var(--color-borde);
        color: var(--color-texto-principal);
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 1em;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    select:focus {
        border-color: var(--color-primario);
        outline: none;
        box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.25);
    }

    .btn-submit {
        background-color: var(--color-primario);
        color: var(--color-texto-inverso);
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 100%;
        margin-top: 10px;
    }

    .btn-submit:hover {
        background-color: var(--color-primario-hover);
    }
    
    .form-message {
        margin-top: 20px;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }

    .form-message.success { color: var(--color-exito); opacity: 1; }
    .form-message.error { color: var(--color-peligro); opacity: 1; }
    
    #results-container { margin-top: 20px; text-align: left; }
    #results-container p { margin: 5px 0; }
    .result-label { font-weight: bold; color: var(--color-texto-secundario); }

    .product-item { display: flex; align-items: center; margin-bottom: 10px; }
    .product-item select, .product-item input[type="number"] { margin-right: 10px; width: auto; }
    
    .btn-add, .btn-remove {
        color: var(--color-texto-inverso);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        width: 35px;
        height: 35px;
        font-size: 1.5em;
        line-height: 35px;
        margin-left: 5px;
        transition: opacity 0.3s;
    }
    .btn-add { background-color: var(--color-exito); }
    .btn-remove { background-color: var(--color-peligro); }
    .btn-add:hover, .btn-remove:hover { opacity: 0.8; }
    
    .total-debt-info {
        font-size: 1.2em;
        font-weight: 600;
        color: var(--color-peligro);
        background-color: rgba(248, 81, 73, 0.1);
        border: 1px solid rgba(248, 81, 73, 0.4);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
    }

    .sale-item {
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid var(--color-borde);
    }
    .sale-item.pending {
        border-left: 5px solid var(--color-primario);
        background-color: var(--color-fondo);
    }
    .sale-item.paid {
        border-left: 5px solid var(--color-exito);
        background-color: var(--color-fondo);
    }
    .btn-pay {
        background-color: var(--color-exito);
        color: var(--color-texto-inverso);
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
        font-weight: 600;
    }
    .sale-details-form {
        background-color: var(--color-fondo);
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
        border: 1px solid var(--color-borde);
    }

    .inventory-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .inventory-table th, .inventory-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--color-borde); }
    .inventory-table th { background-color: #1e242c; color: var(--color-texto-principal); font-weight: 600; }
    .inventory-table tr:hover { background-color: #1e242c; }
    .inventory-table td:last-child { text-align: right; }

    #user-manual-button {
        background-color: var(--color-primario);
        color: var(--color-texto-inverso);
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        z-index: 1000;
        position: fixed;
        top: 20px;
        right: 20px;
        transition: background-color 0.3s;
    }

    #user-manual-button:hover { background-color: var(--color-primario-hover); }

    #user-manual-content {
        position: fixed;
        top: 70px;
        right: 20px;
        background-color: var(--color-superficie);
        color: var(--color-texto-principal);
        border: 1px solid var(--color-borde);
        border-radius: 8px;
        padding: 20px;
        width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 999;
        display: none;
        text-align: left;
        box-shadow: var(--sombra-suave);
    }
    
    #user-manual-content h2, #user-manual-content h3 { color: var(--color-primario); }
    
    .inventory-form-section {
        background-color: var(--color-fondo);
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid var(--color-borde);
    }
    
    .debt-client-header {
        cursor: pointer;
        background-color: var(--color-superficie);
        color: var(--color-texto-principal);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 5px;
        transition: background-color 0.2s, border-color 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--color-borde);
    }
    
    .debt-client-header:hover { background-color: #1e242c; }
    .debt-client-header h4 { margin: 0; color: var(--color-texto-principal); }
    .debt-client-header span { font-weight: 600; color: var(--color-peligro); }
    
    .debt-details {
        display: none;
        padding: 10px 15px;
        margin-bottom: 10px;
        background-color: var(--color-fondo);
        border-left: 3px solid var(--color-primario);
        border-radius: 0 0 8px 8px;
    }

    .dropdown { position: relative; display: inline-block; }
    .dropbtn { background-color: transparent; color: var(--color-texto-secundario); padding: 8px; font-size: 20px; border: none; cursor: pointer; }
    .dropdown-content {
        display: none;
        position: absolute;
        background-color: var(--color-superficie);
        min-width: 120px;
        box-shadow: var(--sombra-suave);
        z-index: 1;
        right: 0;
        border-radius: 5px;
        border: 1px solid var(--color-borde);
        overflow: hidden;
    }
    .dropdown-content a { color: var(--color-texto-principal); padding: 12px 16px; text-decoration: none; display: block; text-align: left; font-size: 0.9em; }
    .dropdown-content a:hover { background-color: var(--color-primario); color: var(--color-texto-inverso); }
    .dropdown:hover .dropdown-content { display: block; }
    
    div[style*="position:fixed"][style*="left:20px"] img {
        height: 100px !important;
        border-radius: 50%;
    }
    /* === CÓDIGO PARA RESPONSIVIDAD (CELULARES) === */
@media (max-width: 768px) {

    body {
        padding: 10px; /* Menos espacio en los bordes de la pantalla */
    }

    .container {
        padding: 15px; /* Menos padding en el contenedor principal */
    }

    /* 1. Hacemos que los botones del menú se apilen verticalmente */
    .tab-menu {
        flex-direction: column;
        gap: 10px;
        align-items: center; /* Centramos los botones */
    }

    .tab-button {
        width: 100%; /* Para que ocupen todo el ancho disponible */
        text-align: center;
    }

    /* 2. Ajustamos la ventana del manual para que quepa */
    #user-manual-content {
        width: 90%;
        max-width: 400px; /* No será más grande que 400px, pero sí más pequeño si es necesario */
        top: 15px;
        right: 5%; /* Centramos un poco más */
        left: 5%;
        max-height: 80vh;
    }

    /* 3. Para que la tabla de inventario no rompa el diseño, permitimos scroll horizontal */
    .inventory-table {
        display: block; /* Necesario para que overflow-x funcione */
        width: 100%;
        overflow-x: auto; /* ¡Magia! Permite deslizar la tabla hacia los lados */
        white-space: nowrap; /* Evita que el texto de las celdas se parta */
    }

    /* 4. Ajustamos tamaños de texto y logos para pantallas pequeñas */
    h1 {
        font-size: 1.8em;
    }

    h2 {
        font-size: 1.4em;
    }

    div[style*="position:fixed"][style*="left:20px"] img {
        height: 60px !important; /* Hacemos el logo de la esquina un poco más pequeño */
    }
}
/* Añade esto al final de tu <style> en index.html */
.debt-container {
    margin-bottom: 10px;
}

.debt-client-header h4 span {
    color: var(--color-texto-secundario);
    font-size: 0.9em;
    font-weight: 400;
}

.total-debt-amount {
    font-weight: 600;
    color: var(--color-peligro);
}

.client-sales-container {
    padding-left: 20px;
    border-left: 2px solid var(--color-borde);
    margin-top: 5px;
}

.sale-debt-item {
    margin: 5px 0;
}

.sale-debt-header {
    background-color: var(--color-fondo);
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    transition: background-color 0.2s;
    border: 1px solid var(--color-borde);
}

.sale-debt-header:hover {
    background-color: #1e242c;
}

.sale-products-container {
    padding: 10px 10px 10px 30px;
    background-color: var(--color-fondo);
    border-radius: 0 0 5px 5px;
}
</style>
</head>
<body>
    <div id="loading-overlay">
        <img src="Logotipo.png" alt="Cargando..." class="loading-logo" style="border-radius: 50%;">
    </div>

    <div style="position:fixed; top:20px; left:20px; z-index:1100;">
        <img src="Logotipo.png" alt="Logo EAInformática" style="height:100px; border-radius: 50%;">
    </div>
    <div id="user-manual-button" onclick="toggleManual()">Manual de Usuario</div>

<div id="user-manual-content">
    <h2>Manual de Usuario</h2>
    <p>Bienvenido a <strong>EAInformática Gestión</strong>, una herramienta integral para gestionar clientes, ventas, inventario y cuentas por cobrar. Este sistema fue diseñado para pequeñas empresas que desean llevar un control digital y eficiente de sus operaciones sin depender de software costoso.</p>

    <div class="manual-section">
        <h3>Requisitos Técnicos</h3>
        <ul>
            <li>Navegador actualizado (Google Chrome recomendado).</li>
            <li>Conexión a internet estable.</li>
            <li>Acceso autorizado al sistema (URL personalizada).</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>1. Registrar Cliente</h3>
        <p>Completa todos los campos del formulario y haz clic en <strong>"Guardar Cliente"</strong>. La información se guarda en la hoja <code>Clientes</code>.</p>
        <ul>
            <li><strong>Nombre:</strong> Nombre completo.</li>
            <li><strong>CPF/CNPJ:</strong> Identificación fiscal (sin puntos ni guiones).</li>
            <li><strong>Email:</strong> Correo electrónico válido.</li>
            <li><strong>Teléfono/Dirección:</strong> Opcionales pero recomendados.</li>
            <li><strong>Fecha:</strong> Fecha del registro.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>2. Buscar Cliente & Registrar Venta</h3>
        <h4>2.1 Buscar Cliente</h4>
        <p>Introduce el <strong>CPF/CNPJ</strong> y presiona <strong>Buscar</strong>. Si el cliente existe, verás sus datos y ventas.</p>

        <h4>2.2 Registrar Venta</h4>
        <p>Agrega productos con el botón <code>+</code>. Selecciona producto y cantidad. Puedes ingresar un <strong>abono inicial</strong>. Presiona <strong>Guardar Venta</strong>. Se actualiza automáticamente el stock.</p>

        <h4>2.3 Ver Ventas y Pagar</h4>
        <ul>
            <li>Historial muestra ventas con estado <strong>Pagado</strong> o <strong>Pendiente</strong>.</li>
            <li>Haz clic en <code>+</code> para ver productos vendidos.</li>
            <li>Si hay deuda, haz clic en <strong>Pagar</strong> para abonar.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>3. Inventario de Productos</h3>
        <p>Visualiza todos los productos con su precio y stock. El stock se actualiza con cada venta.</p>

        <h4>3.1 Agregar Producto</h4>
        <ul>
            <li>Si el producto <strong>ya existe</strong>, solo se suma stock. Precio no es obligatorio.</li>
            <li>Si el producto <strong>es nuevo</strong>, completa nombre, precio y stock.</li>
        </ul>

        <h4>3.2 Editar o Eliminar</h4>
        <ul>
            <li>Usa el menú <code>...</code> junto al producto.</li>
            <li>"Editar" permite modificar nombre, precio y stock.</li>
            <li>"Borrar" elimina el producto permanentemente.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>4. Cuentas por Cobrar</h3>
        <p>Muestra todos los clientes con ventas pendientes. Haz clic en el nombre del cliente para ver detalles de las deudas.</p>

        <ul>
            <li>Visualiza <strong>total adeudado</strong> y detalle por venta.</li>
            <li>Te permite dar seguimiento y contactar clientes fácilmente.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>5. Preguntas Frecuentes (FAQ)</h3>
        <ul>
            <li><strong>¿Qué pasa si ingreso mal un dato?</strong> Puedes editar clientes o productos desde la hoja de cálculo.</li>
            <li><strong>¿Se guarda automáticamente?</strong> Sí, cada acción actualiza las hojas correspondientes.</li>
            <li><strong>¿Puedo usarlo en celular?</strong> Sí, es 100% responsive y funciona en dispositivos móviles.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>Soporte Técnico</h3>
        <p>¿Tienes preguntas o necesitas ayuda?</p>
        <ul>
            <li><strong>WhatsApp:</strong> <a href="https://wa.me/5549991839170" target="_blank">+55 49 99183-9170</a></li>
            <li><strong>Email:</strong> <a href="mailto:aeinformatica7@gmail.com">aeinformatica7@gmail.com</a></li>
        </ul>
        <p>Con gusto te atenderé. 😊</p>
    </div>
</div>


<div class="container">
    <div style="text-align:center; margin-bottom:10px; margin-top:10px;">
    <h1 style="color:#00d8ff; font-size:2.5em; margin-bottom:0;">EAInformática</h1>
    <p style="color:#0077ff; font-size:1.2em; margin-top:5px; font-weight:500;">Trabajamos con Inteligencia</p>
</div>
    <div class="tab-menu" id="tab-menu">
        <button class="tab-button active" id="tab-client" onclick="openTab('clientTab', this)">Registrar Cliente</button>
        <button class="tab-button" id="tab-search" onclick="openTab('searchTab', this)">Buscar Cliente & Ventas</button>
        <button class="tab-button" id="tab-inventory" onclick="openTab('inventoryTab', this)">Inventario</button>
        <button class="tab-button" id="tab-debt" onclick="openTab('debtTab', this)">Cuentas por Cobrar</button>
    </div>

    <div id="clientTab" class="tab-content active">
        <div class="form-container">
            <h2>Registro de Clientes</h2>
            <form id="customerForm">
                <input type="hidden" name="action" value="addClient">
                <div class="form-group">
                    <label for="Nome">Nombre</label>
                    <input type="text" id="Nome" name="Nome" required>
                </div>
                <div class="form-group">
                    <label for="CPF/CNPJ">CPF/CNPJ</label>
                    <input type="text" id="CPF/CNPJ" name="CPF/CNPJ" required>
                </div>
                <div class="form-group">
                    <label for="Email">Email</label>
                    <input type="email" id="Email" name="Email" required>
                </div>
                <div class="form-group">
                    <label for="Telefono">Teléfono</label>
                    <input type="text" id="Telefono" name="Telefono">
                </div>
                <div class="form-group">
                    <label for="Direccion">Dirección</label>
                    <input type="text" id="Direccion" name="Direccion">
                </div>
                <button type="submit" class="btn-submit">Guardar Cliente</button>
                <p id="form-message" class="form-message"></p>
            </form>
        </div>
    </div>

    <div id="searchTab" class="tab-content">
        <div class="form-container">
            <h2>Buscar Cliente y Registrar Venta</h2>
            <form id="searchForm">
                <div class="form-group" id="search-cpf-container">
                    <label for="search-cpf">Buscar por CPF/CNPJ</label>
                    <input type="text" id="search-cpf" name="CPF/CNPJ" required>
                </div>
                <button type="submit" class="btn-submit">Buscar</button>
                <p id="search-message" class="form-message"></p>
            </form>
            <div id="results-container"></div>
        </div>
    </div>

    <div id="inventoryTab" class="tab-content">
        <div class="form-container">
            <h2>Inventario de Productos</h2>
            <div id="inventory-list">
                <p>Cargando inventario...</p>
            </div>
            
            <div class="inventory-form-section" id="addProductSection">
                <form id="addProductForm">
                    <h3 style="color: #8e24aa;">Agregar Nuevo Producto</h3>
                    
                    <div class="form-group">
                        <label for="product-name">Nombre del Producto</label>
                        <input type="text" id="product-name" name="Nombre_del_producto" required>
                    </div>

                    <div class="form-group">
                        <label for="product-price">Precio</label>
                        <input type="number" id="product-price" name="Precio" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="product-stock">Stock a añadir</label>
                        <input type="number" id="product-stock" name="Stock" min="0" required>
                    </div>
                    <button type="submit" class="btn-submit">Agregar Producto</button>
                    <p id="add-product-message" class="form-message"></p>
                </form>
            </div>
            
            <div class="inventory-form-section" id="editProductSection" style="display:none;">
                <form id="editProductForm">
                    <h3 style="color: #8e24aa;">Editar Producto</h3>
                    <input type="hidden" id="edit-product-id" name="ID_Producto">
                    
                    <div class="form-group">
                        <label for="edit-product-name">Nombre del Producto</label>
                        <input type="text" id="edit-product-name" name="Nombre_del_producto" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-product-price">Precio</label>
                        <input type="number" id="edit-product-price" name="Precio" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-product-stock">Stock a modificar (se sumará al stock actual)</label>
                        <input type="number" id="edit-product-stock" name="Stock" required>
                    </div>
                    <button type="submit" class="btn-submit">Guardar Cambios</button>
                    <button type="button" class="btn-submit" onclick="cancelEdit()">Cancelar</button>
                    <p id="edit-product-message" class="form-message"></p>
                </form>
            </div>

        </div>
    </div>

    <div id="debtTab" class="tab-content">
        <div class="form-container">
            <h2>Cuentas por Cobrar</h2>
            <div id="debt-list">
                <p>Cargando cuentas pendientes...</p>
            </div>
        </div>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbybxe6Iu6rlXzk6_rQLkirk2Vi1couqQ8nFhFh8nSmJ_4bWZarpn5WxVDTLAbKLcMLL/exec'; 

    let allProducts = [];
    let salesProducts = [];

    function showLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }

    async function loadApp() {
        try {
            // Espera a que el DOM esté listo y el tab exista
            setTimeout(() => {
                const firstTabButton = document.getElementById('tab-client');
                if (firstTabButton) {
                    openTab('clientTab', firstTabButton);
                }
            }, 100);
            await fetchProducts();
        } catch (error) {
            console.error("Error al cargar la aplicación:", error);
            alert("Hubo un problema al cargar la aplicación. Por favor, recarga la página. Mensaje: " + error.message);
        }
    }

    async function fetchProducts() {
        showLoading();
        try {
            const productsResponse = await fetch(scriptURL + '?action=getProducts');
            if (!productsResponse.ok) throw new Error('Error al obtener los productos.');
            allProducts = await productsResponse.json();
        } catch (error) {
            console.error("Error al cargar los productos:", error);
            allProducts = []; // Asegura que allProducts sea un array vacío si falla
        } finally {
            hideLoading();
        }
    }
    
    function openTab(tabName, button) {
        var i, tabContent, tabButtons;
        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
        }
        tabButtons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabButtons.length; i++) {
            tabButtons[i].className = tabButtons[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        if (button) {
            button.className += " active";
        }
        if (tabName === 'inventoryTab') {
            loadInventory();
            document.getElementById('addProductSection').style.display = 'block';
            document.getElementById('editProductSection').style.display = 'none';
        } else if (tabName === 'debtTab') {
            loadPendingSales();
        }
    }

    async function loadInventory() {
        const inventoryList = document.getElementById('inventory-list');
        
        inventoryList.innerHTML = '<p>Cargando inventario...</p>';
        
        await fetchProducts();

        if (allProducts.length > 0) {
            let html = '<table class="inventory-table">';
            html += '<thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th></th></tr></thead>';
            html += '<tbody>';
            allProducts.forEach(product => {
                html += `<tr>
                           <td>${product['ID_Producto']}</td>
                           <td>${product['Nombre_del_producto']}</td>
                           <td>R$ ${product.Precio.toFixed(2)}</td>
                           <td>${product.Stock}</td>
                           <td>
                                <div class="dropdown">
                                    <button class="dropbtn">...</button>
                                    <div class="dropdown-content">
                                        <a href="#" onclick="editProduct('${product['ID_Producto']}', '${product['Nombre_del_producto']}', '${product.Precio}', '${product.Stock}')">Editar</a>
                                        <a href="#" onclick="deleteProduct('${product['ID_Producto']}')">Borrar</a>
                                    </div>
                                </div>
                           </td>
                         </tr>`;
            });
            html += '</tbody></table>';
            inventoryList.innerHTML = html;
        } else {
            inventoryList.innerHTML = '<p>No hay productos en el inventario.</p>';
        }
    }
    
    function editProduct(id, name, price, stock) {
        document.getElementById('addProductSection').style.display = 'none';
        document.getElementById('editProductSection').style.display = 'block';
        
        document.getElementById('edit-product-id').value = id;
        document.getElementById('edit-product-name').value = name;
        document.getElementById('edit-product-price').value = price;
        document.getElementById('edit-product-stock').value = 0;
    }
    
    function cancelEdit() {
        document.getElementById('editProductForm').reset();
        document.getElementById('addProductSection').style.display = 'block';
        document.getElementById('editProductSection').style.display = 'none';
    }
    
    async function deleteProduct(id) {
        if (!confirm('¿Estás seguro de que quieres borrar este producto? Esta acción es irreversible.')) {
            return;
        }
        
        showLoading();
        try {
            const formData = new FormData();
            formData.append('action', 'deleteProduct');
            formData.append('ID_Producto', id);
            
            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();
            
            if (response.ok) {
                if (resultText.includes("Error")) {
                    alert(resultText);
                } else {
                    alert('Producto eliminado con éxito.');
                    loadInventory();
                }
            } else {
                alert('Error al procesar la solicitud.');
            }
        } catch (error) {
            alert('Hubo un problema de conexión.');
        } finally {
            hideLoading();
        }
    }

async function loadPendingSales() {
    const debtList = document.getElementById('debt-list');
    debtList.innerHTML = '<p>Cargando cuentas pendientes...</p>';
    showLoading();
    try {
        const response = await fetch(scriptURL + '?action=getPendingSales');
        const groupedSales = await response.json();
        
        if (groupedSales.length > 0) {
            let html = '<h3>Deuda Total por Cliente</h3>';
            groupedSales.forEach((client, clientIndex) => {
                html += `
                    <div class="debt-container">
                        <div class="debt-client-header" onclick="toggleVisibility('client-sales-${clientIndex}')">
                            <h4>${client.nombreCliente} <span>(CPF/CNPJ: ${client.cpfCnpj})</span></h4>
                            <span class="total-debt-amount">Deuda Total: R$ ${client.deudaTotal.toFixed(2)}</span>
                        </div>
                        
                        <div class="client-sales-container" id="client-sales-${clientIndex}" style="display: none;">
                            ${client.ventas.map((sale, saleIndex) => `
                                <div class="sale-debt-item">
                                    <div class="sale-debt-header" onclick="toggleVisibility('sale-products-${clientIndex}-${saleIndex}')">
                                        <span><strong>ID Venta:</strong> ${sale.id}</span>
                                        <span><strong>Fecha:</strong> ${new Date(sale.fecha).toLocaleDateString()}</span>
                                        <span><strong>Deuda:</strong> R$ ${sale.deudaRestante.toFixed(2)}</span>
                                    </div>
                                    
                                    <div class="sale-products-container" id="sale-products-${clientIndex}-${saleIndex}" style="display: none;">
                                        <ul>
                                            ${sale.productos.map(p => `<li>${p.nombre} (${p.cantidad} unidad/es)</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            debtList.innerHTML = html;
        } else {
            debtList.innerHTML = '<p>No hay cuentas pendientes en este momento.</p>';
        }
    } catch (error) {
        console.error("Error al cargar las cuentas pendientes:", error);
        debtList.innerHTML = '<p>Error al cargar las cuentas pendientes.</p>';
    } finally {
        hideLoading();
    }
}
    
function toggleVisibility(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = element.style.display === 'block' ? 'none' : 'block';
    }
}

    if (document.getElementById('customerForm')) {
      const customerForm = document.getElementById('customerForm');
      const customerMessage = document.getElementById('form-message');
      customerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          customerMessage.textContent = 'Enviando...';
          customerMessage.className = 'form-message';
          showLoading();
          try {
              const formData = new FormData(customerForm);
              // Agrega la fecha actual automáticamente
              formData.append('Fecha', new Date().toISOString());
              const response = await fetch(scriptURL, { method: 'POST', body: formData });
              const resultText = await response.text();
              if (response.ok) {
                  if (resultText.includes("Error")) {
                      customerMessage.textContent = resultText;
                      customerMessage.className = 'form-message error';
                  } else {
                      customerMessage.textContent = '¡Cliente registrado con éxito!';
                      customerMessage.className = 'form-message success';
                      customerForm.reset();
                  }
              } else {
                  customerMessage.textContent = 'Error al registrar el cliente.';
                  customerMessage.className = 'form-message error';
              }
          } catch (error) {
              customerMessage.textContent = 'Hubo un problema de conexión.';
              customerMessage.className = 'form-message error';
          } finally {
              hideLoading();
          }
      });
    }

    const searchForm = document.getElementById('searchForm');
    const searchMessage = document.getElementById('search-message');
    const resultsContainer = document.getElementById('results-container');

    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        resultsContainer.innerHTML = '';
        searchMessage.textContent = 'Buscando...';
        searchMessage.className = 'form-message';
        showLoading();
        const searchCpfCnpj = document.getElementById('search-cpf').value;

        try {
            const url = scriptURL + '?action=search&CPF/CNPJ=' + searchCpfCnpj;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data && data.Nome) {
                searchMessage.textContent = 'Cliente encontrado:';
                searchMessage.className = 'form-message success';
                
                let salesHtml = data.sales.length > 0
                    ? `<h4>Historial de Ventas:</h4>
                       <ul>
                           ${data.sales.map(sale => `
                               <li class="sale-item ${sale.estado === 'Pagado' ? 'paid' : 'pending'}">
                                   <p><span class="result-label">ID Venta:</span> ${sale.id} | 
                                   <span class="result-label">Monto Total:</span> R$ ${sale.montoTotal.toFixed(2)} | 
                                   <span class="result-label">Pagado:</span> R$ ${sale.montoPagado.toFixed(2)} | 
                                   <span class="result-label">Deuda:</span> R$ ${sale.deudaRestante.toFixed(2)}</p>
                                   <p><span class="result-label">Fecha:</span> ${new Date(sale.fecha).toLocaleDateString()}
                                   <button onclick="toggleSaleDetails(this)">+</button>
                                   ${sale.estado === 'Pendiente' ? `<button class="btn-pay" onclick="showPaymentForm(${sale.id}, ${sale.deudaRestante})">Pagar</button>` : `<span style="color:#4CAF50; font-weight:bold;">(${sale.estado})</span>`}</p>
                                   
                                   <div class="sale-details" style="display:none;">
                                        <ul>
                                            ${sale.productos.map(p => `<li>${p.nombre} (${p.cantidad} unidad/es)</li>`).join('')}
                                        </ul>
                                   </div>
                               </li>
                           `).join('')}
                       </ul>`
                    : `<p>Este cliente no tiene ventas registradas.</p>`;

                resultsContainer.innerHTML = `
                    <p><span class="result-label">Nombre:</span> ${data.Nome}</p>
                    <p><span class="result-label">CPF/CNPJ:</span> ${data['CPF/CNPJ']}</p>
                    <p><span class="result-label">Email:</span> ${data.Email}</p>
                    <p><span class="result-label">Teléfono:</span> ${data.Telefono || 'N/A'}</p>
                    <p><span class="result-label">Dirección:</span> ${data.Direccion || 'N/A'}</p>
                    <p><span class="result-label">Fecha de Registro:</span> ${new Date(data.Fecha).toLocaleDateString()}</p>
                    <hr>
                    <p class="total-debt-info"><strong>Deuda Total Pendiente: R$ ${data.totalDebt}</strong></p>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="color: #8e24aa;">Registrar Nueva Venta para ${data.Nome}</h3>
                        <form id="saleForm">
                            <input type="hidden" name="action" value="addSale">
                            <input type="hidden" name="CPF/CNPJ" value="${data['CPF/CNPJ']}">
                            <input type="hidden" id="productsJson" name="Productos">
                            <input type="hidden" id="totalAmount" name="MontoTotal">
                            
                            <div id="products-list"></div>
                            <div style="text-align: right;">
                                <button type="button" onclick="addProductField()" class="btn-add">+</button>
                            </div>
                            <div class="form-group" style="margin-top: 20px;">
                                <label for="initialPayment">Abono Inicial (opcional)</label>
                                <input type="number" id="initialPayment" name="Monto_Pagado" step="0.01" min="0">
                            </div>
                            <br>
                            <button type="submit" class="btn-submit">Guardar Venta</button>
                            <p id="sale-message" class="form-message"></p>
                        </form>
                    </div>

                    ${salesHtml}
                `;
                salesProducts = [];
                addProductField();
                const saleForm = document.getElementById('saleForm');
                const saleMessage = document.getElementById('sale-message');
                saleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    saleMessage.textContent = 'Calculando y enviando...';
                    saleMessage.className = 'form-message';
                    showLoading();
                    
                    let total = 0;
                    const finalProducts = [];
                    salesProducts.forEach(p => {
                        const product = allProducts.find(prod => prod.ID_Producto == p.id);
                        if (product) {
                            total += product.Precio * p.cantidad;
                            finalProducts.push({
                                id: product.ID_Producto,
                                nombre: product.Nombre_del_producto,
                                cantidad: p.cantidad
                            });
                        }
                    });

                    document.getElementById('totalAmount').value = total;
                    document.getElementById('productsJson').value = JSON.stringify(finalProducts);

                    try {
                        const formData = new FormData(saleForm);
                        // Agrega la fecha actual automáticamente
                        formData.append('Fecha', new Date().toISOString());
                        const response = await fetch(scriptURL, { method: 'POST', body: formData });
                        const resultText = await response.text();
                        if (response.ok) {
                            if (resultText.includes("Error")) {
                                saleMessage.textContent = resultText;
                                saleMessage.className = 'form-message error';
                            } else {
                                saleMessage.textContent = '¡Venta registrada con éxito!';
                                saleMessage.className = 'form-message success';
                                saleForm.reset();
                                salesProducts = [];
                                resultsContainer.innerHTML = '';
                                searchForm.dispatchEvent(new Event('submit'));
                            }
                        } else {
                            saleMessage.textContent = 'Error al registrar la venta.';
                            saleMessage.className = 'form-message error';
                        }
                    } catch (error) {
                        saleMessage.textContent = 'Hubo un problema de conexión.';
                        saleMessage.className = 'form-message error';
                    } finally {
                        hideLoading();
                    }
                });
                
            } else {
                searchMessage.textContent = 'No se encontró ningún cliente con ese CPF/CNPJ.';
                searchMessage.className = 'form-message error';
            }
        } catch (error) {
            searchMessage.textContent = 'Hubo un problema en la búsqueda: ' + error.message;
            searchMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
    });
    
    async function handlePayment(saleId, paymentAmount) {
        const paymentMessage = document.getElementById(`payment-message-${saleId}`);
        paymentMessage.textContent = 'Registrando pago...';
        paymentMessage.className = 'form-message';
        showLoading();
        try {
            const formData = new FormData();
            formData.append('action', 'addPayment');
            formData.append('ID_Transaccion', saleId);
            formData.append('Monto_Pago', paymentAmount);

            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();
            if (response.ok) {
                if (resultText.includes("Error")) {
                    paymentMessage.textContent = resultText;
                    paymentMessage.className = 'form-message error';
                } else {
                    paymentMessage.textContent = '¡Pago registrado con éxito!';
                    paymentMessage.className = 'form-message success';
                    searchForm.dispatchEvent(new Event('submit'));
                }
            } else {
                paymentMessage.textContent = 'Error al registrar el pago.';
                paymentMessage.className = 'form-message error';
            }
        } catch (error) {
            paymentMessage.textContent = 'Hubo un problema de conexión.';
            paymentMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
    }

    function showPaymentForm(saleId, currentDebt) {
        const formId = `payment-form-${saleId}`;
        const existingForm = document.getElementById(formId);
        if (existingForm) {
            existingForm.remove();
            return;
        }

        const paymentForm = document.createElement('form');
        paymentForm.id = formId;
        paymentForm.className = 'sale-details-form';
        paymentForm.onsubmit = (e) => {
            e.preventDefault();
            const amountInput = paymentForm.querySelector('input');
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0 || amount > currentDebt) {
                alert(`El monto debe ser un número positivo y no mayor a la deuda restante de R$ ${currentDebt.toFixed(2)}.`);
                return;
            }
            handlePayment(saleId, amount);
        };
        
        paymentForm.innerHTML = `
            <div class="form-group">
                <label for="payment-amount-${saleId}">Monto a pagar (Deuda: R$ ${currentDebt.toFixed(2)})</label>
                <input type="number" id="payment-amount-${saleId}" step="0.01" min="0.01" max="${currentDebt}" required>
            </div>
            <button type="submit" class="btn-submit">Registrar Abono</button>
            <p id="payment-message-${saleId}" class="form-message"></p>
        `;

        const saleItem = document.querySelector(`.sale-item .btn-pay[onclick*="${saleId}"]`).closest('.sale-item');
        saleItem.appendChild(paymentForm);
    }
    
    function addProductField() {
        const productsListDiv = document.getElementById('products-list');
        const index = salesProducts.length;

        const productSelect = document.createElement('select');
        productSelect.innerHTML = allProducts.map(p => 
            `<option value="${p.ID_Producto}" data-price="${p.Precio}" data-stock="${p.Stock}">${p.Nombre_del_producto} (Stock: ${p.Stock})</option>`
        ).join('');
        productSelect.onchange = (e) => updateProduct(index, e.target.value, salesProducts[index].cantidad);

        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.value = 1;
        quantityInput.min = 1;
        quantityInput.onchange = (e) => updateProduct(index, salesProducts[index].id, parseInt(e.target.value));
        quantityInput.style.width = '80px';
        
        const removeButton = document.createElement('button');
        removeButton.textContent = '-';
        removeButton.type = 'button';
        removeButton.className = 'btn-remove';
        removeButton.onclick = () => removeProductField(index);

        const productItem = document.createElement('div');
        productItem.className = 'product-item';
        productItem.id = `product-item-${index}`;
        productItem.appendChild(productSelect);
        productItem.appendChild(quantityInput);
        productItem.appendChild(removeButton);
        productsListDiv.appendChild(productItem);

        if (allProducts.length > 0) {
            salesProducts.push({
                id: allProducts[0].ID_Producto,
                cantidad: 1
            });
        }
    }

    function updateProduct(index, productId, quantity) {
        salesProducts[index].id = productId;
        salesProducts[index].cantidad = quantity;
    }

    function removeProductField(index) {
        const element = document.getElementById(`product-item-${index}`);
        if (element) {
            element.remove();
        }
        salesProducts.splice(index, 1);

        const productsListDiv = document.getElementById('products-list');
        productsListDiv.innerHTML = '';
        salesProducts.forEach((p, i) => {
            const productSelect = document.createElement('select');
            productSelect.innerHTML = allProducts.map(prod => 
                `<option value="${prod.ID_Producto}" data-price="${prod.Precio}" data-stock="${prod.Stock}">${prod.Nombre_del_producto} (Stock: ${prod.Stock})</option>`
            ).join('');
            productSelect.value = p.id;
            productSelect.onchange = (e) => updateProduct(i, e.target.value, salesProducts[i].cantidad);

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.value = p.cantidad;
            quantityInput.min = 1;
            quantityInput.onchange = (e) => updateProduct(i, salesProducts[i].id, parseInt(e.target.value));
            quantityInput.style.width = '80px';
            
            const removeButton = document.createElement('button');
            removeButton.textContent = '-';
            removeButton.type = 'button';
            removeButton.className = 'btn-remove';
            removeButton.onclick = () => removeProductField(i);

            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.id = `product-item-${i}`;
            productItem.appendChild(productSelect);
            productItem.appendChild(quantityInput);
            productItem.appendChild(removeButton);
            productsListDiv.appendChild(productItem);
        });
    }

    function toggleSaleDetails(button) {
        const saleItem = button.closest('.sale-item');
        if (saleItem) {
            const details = saleItem.querySelector('.sale-details');
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        }
    }

    const addProductForm = document.getElementById('addProductForm');
    const addProductMessage = document.getElementById('add-product-message');
    if (addProductForm) {
      addProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        addProductMessage.textContent = 'Enviando...';
        addProductMessage.className = 'form-message';
        showLoading();
        
        const productName = document.getElementById('product-name').value;
        const productPrice = document.getElementById('product-price').value;
        const productStock = document.getElementById('product-stock').value;

        if (!productName.trim()) {
            addProductMessage.textContent = 'El nombre del producto es obligatorio.';
            addProductMessage.className = 'form-message error';
            hideLoading();
            return;
        }
        if (!productStock || parseInt(productStock) <= 0) {
            addProductMessage.textContent = 'La cantidad a añadir debe ser un número positivo.';
            addProductMessage.className = 'form-message error';
            hideLoading();
            return;
        }

        const formData = new FormData();
        formData.append('action', 'addProduct');
        formData.append('Nombre_del_producto', productName);
        formData.append('Precio', productPrice);
        formData.append('Stock', productStock);
        

        try {
          const response = await fetch(scriptURL, { method: 'POST', body: formData });
          const resultText = await response.text();
          if (response.ok) {
            if (resultText.includes("Error")) {
              addProductMessage.textContent = resultText;
              addProductMessage.className = 'form-message error';
            } else {
              addProductMessage.textContent = '¡Operación exitosa!';
              addProductMessage.className = 'form-message success';
              addProductForm.reset();
              loadInventory();
            }
          } else {
            addProductMessage.textContent = 'Error al procesar la solicitud.';
            addProductMessage.className = 'form-message error';
          }
        } catch (error) {
          addProductMessage.textContent = 'Hubo un problema de conexión.';
          addProductMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
      });
    }
    
    const editProductForm = document.getElementById('editProductForm');
    const editProductMessage = document.getElementById('edit-product-message');
    if (editProductForm) {
      editProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        editProductMessage.textContent = 'Enviando...';
        editProductMessage.className = 'form-message';
        showLoading();
        
        const productId = document.getElementById('edit-product-id').value;
        const productName = document.getElementById('edit-product-name').value;
        const productPrice = document.getElementById('edit-product-price').value;
        const productStock = document.getElementById('edit-product-stock').value;

        const formData = new FormData();
        formData.append('action', 'updateProduct');
        formData.append('ID_Producto', productId);
        formData.append('Nombre_del_producto', productName);
        formData.append('Precio', productPrice);
        formData.append('Stock', productStock);
        

        try {
          const response = await fetch(scriptURL, { method: 'POST', body: formData });
          const resultText = await response.text();
          if (response.ok) {
            if (resultText.includes("Error")) {
              editProductMessage.textContent = resultText;
              editProductMessage.className = 'form-message error';
            } else {
              editProductMessage.textContent = '¡Operación exitosa!';
              editProductMessage.className = 'form-message success';
              editProductForm.reset();
              loadInventory();
              cancelEdit();
            }
          } else {
            editProductMessage.textContent = 'Error al procesar la solicitud.';
            editProductMessage.className = 'form-message error';
          }
        } catch (error) {
          editProductMessage.textContent = 'Hubo un problema de conexión.';
          editProductMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
      });
    }

    function toggleManual() {
        const manualContent = document.getElementById('user-manual-content');
        if (manualContent.style.display === 'block') {
            manualContent.style.display = 'none';
        } else {
            manualContent.style.display = 'block';
        }
    }
    
    document.addEventListener('DOMContentLoaded', loadApp);
</script>
</body>
</html>