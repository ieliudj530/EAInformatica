<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empresas EAInformática</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #121212; /* Fondo oscuro */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #f5f5f5; /* Texto claro */
            flex-direction: column;
            padding: 20px;
            position: relative; /* Necessário para posicionar o botão do manual */
        }
        
        /* Estilos del overlay de carga */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #6a1b9a;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: #1e1e1e; /* Contenedor más claro que el fondo */
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Estilos del menú de pestañas */
        .tab-menu {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .tab-button {
            background-color: #2a2a2a;
            border: 2px solid #3d3d3d;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #ccc;
            transition: background-color 0.3s, color 0.3s, border 0.3s;
            width: 100%;
            border-radius: 8px; /* Esquinas redondeadas */
            margin-bottom: 10px;
        }

        .tab-button.active {
            color: white;
            background-color: #6a1b9a;
            border: 2px solid #6a1b9a;
        }
        
        .tab-button:last-child {
            margin-bottom: 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-container {
            padding: 20px 0;
            text-align: center;
        }

        h2 {
            color: #6a1b9a; /* Morado oscuro, sigue siendo el color de acento */
            margin-bottom: 25px;
            font-size: 2em;
            text-align: left;
        }

        h3 {
            color: #8e24aa;
            margin-bottom: 15px;
            font-size: 1.5em;
            text-align: left;
        }

        h4 {
            color: #ab47bc;
            margin-bottom: 10px;
            font-size: 1.2em;
            text-align: left;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ccc;
        }

        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            background-color: #333;
            border: 1px solid #555;
            color: #f5f5f5;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #6a1b9a;
            outline: none;
        }

        .btn-submit {
            background-color: #8e24aa; /* Morado brillante */
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn-submit:hover {
            background-color: #ab47bc; /* Morado un poco más claro */
            transform: translateY(-2px);
        }
        
        .form-message {
            margin-top: 20px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .form-message.success {
            color: #4CAF50;
            opacity: 1;
        }

        .form-message.error {
            color: #f44336;
            opacity: 1;
        }
        
        #results-container {
            margin-top: 20px;
            text-align: left;
        }

        #results-container p {
            margin: 5px 0;
        }

        .result-label {
            font-weight: bold;
            color: #ab47bc; /* Tono morado claro para etiquetas */
        }

        /* Estilos para el detalle de productos */
        .product-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .product-item select, .product-item input[type="number"] {
            margin-right: 10px;
            width: auto;
        }
        .btn-add, .btn-remove {
            background-color: #6a1b9a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            margin-left: 5px;
        }
        .btn-remove {
            background-color: #f44336;
        }
        .btn-add:hover, .btn-remove:hover {
            opacity: 0.8;
        }
        .total-debt-info {
            font-size: 1.2em;
            font-weight: 600;
            color: #f44336;
            border: 2px solid #f44336;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .sale-item.pending {
            border-left: 5px solid #f44336;
            padding-left: 10px;
            background-color: #2a1a1a;
        }
        .sale-item.paid {
            border-left: 5px solid #4CAF50;
            padding-left: 10px;
            background-color: #1a2a1a;
        }
        .btn-pay {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        .sale-details-form {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Nuevos estilos para la tabla de inventario y cuentas */
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .inventory-table th, .inventory-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #3d3d3d;
        }
        .inventory-table th {
            background-color: #6a1b9a;
            color: white;
            font-weight: 600;
        }
        .inventory-table tr:nth-child(even) {
            background-color: #121212;
        }
        .inventory-table tr:hover {
            background-color: #333;
        }
        .inventory-table td:last-child {
            text-align: right;
        }

        /* Estilos para el botón del manual */
        #user-manual-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #424242;
            color: #f5f5f5;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            z-index: 1000; /* Para garantizar que quede encima de otros elementos */
            transition: background-color 0.3s;
        }

        #user-manual-button:hover {
            background-color: #616161;
        }

        /* Estilos para el contenido del manual (inicialmente oculto) */
        #user-manual-content {
            position: fixed;
            top: 60px;
            right: 20px;
            background-color: #2a2a2a;
            color: #ccc;
            border: 1px solid #3d3d3d;
            border-radius: 8px;
            padding: 20px;
            width: 400px; /* Ajusta la anchura según sea necesario */
            max-height: 80vh;
            overflow-y: auto;
            z-index: 999;
            display: none; /* Inicialmente oculto */
            text-align: left; /* Contenido aliniado a la izquierda */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        #user-manual-content h2 {
            color: #8e24aa;
            margin-top: 0;
        }

        #user-manual-content h3 {
            color: #ab47bc;
        }

        #user-manual-content ul {
            padding-left: 20px;
        }

        #user-manual-content code {
            background-color: #333;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
            color: #fff;
        }

        .inventory-form-section {
            background-color: #2e2e2e;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .debt-client-header {
            cursor: pointer;
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .debt-client-header:hover {
            background-color: #444;
        }
        
        .debt-client-header h4 {
            margin: 0;
            color: #ab47bc;
        }
        
        .debt-client-header span {
            font-weight: 600;
        }
        
        .debt-details {
            display: none;
            padding: 10px 15px;
            margin-bottom: 10px;
            background-color: #2a2a2a;
            border-left: 3px solid #8e24aa;
            border-radius: 0 0 8px 8px;
        }
        
        .debt-details p {
            margin: 5px 0;
        }

        /* Estilos para el menú de 3 puntos */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropbtn {
            background-color: transparent;
            color: #ccc;
            padding: 8px;
            font-size: 20px;
            border: none;
            cursor: pointer;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #333;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 1;
            right: 0;
            border-radius: 5px;
        }

        .dropdown-content a {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            font-size: 0.9em;
        }

        .dropdown-content a:hover {
            background-color: #4CAF50;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
</div>

<div id="user-manual-button" onclick="toggleManual()">Manual de Usuario</div>

<div id="user-manual-content">
    <h2>Manual de Usuario</h2>
    <p>Bienvenido a <strong>EAInformática Gestión</strong>, una herramienta integral para gestionar clientes, ventas, inventario y cuentas por cobrar. Este sistema fue diseñado para pequeñas empresas que desean llevar un control digital y eficiente de sus operaciones sin depender de software costoso.</p>

    <div class="manual-section">
        <h3>Requisitos Técnicos</h3>
        <ul>
            <li>Navegador actualizado (Google Chrome recomendado).</li>
            <li>Conexión a internet estable.</li>
            <li>Acceso autorizado al sistema (URL personalizada).</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>1. Registrar Cliente</h3>
        <p>Completa todos los campos del formulario y haz clic en <strong>"Guardar Cliente"</strong>. La información se guarda en la hoja <code>Clientes</code>.</p>
        <ul>
            <li><strong>Nombre:</strong> Nombre completo.</li>
            <li><strong>CPF/CNPJ:</strong> Identificación fiscal (sin puntos ni guiones).</li>
            <li><strong>Email:</strong> Correo electrónico válido.</li>
            <li><strong>Teléfono/Dirección:</strong> Opcionales pero recomendados.</li>
            <li><strong>Fecha:</strong> Fecha del registro.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>2. Buscar Cliente & Registrar Venta</h3>
        <h4>2.1 Buscar Cliente</h4>
        <p>Introduce el <strong>CPF/CNPJ</strong> y presiona <strong>Buscar</strong>. Si el cliente existe, verás sus datos y ventas.</p>

        <h4>2.2 Registrar Venta</h4>
        <p>Agrega productos con el botón <code>+</code>. Selecciona producto y cantidad. Puedes ingresar un <strong>abono inicial</strong>. Presiona <strong>Guardar Venta</strong>. Se actualiza automáticamente el stock.</p>

        <h4>2.3 Ver Ventas y Pagar</h4>
        <ul>
            <li>Historial muestra ventas con estado <strong>Pagado</strong> o <strong>Pendiente</strong>.</li>
            <li>Haz clic en <code>+</code> para ver productos vendidos.</li>
            <li>Si hay deuda, haz clic en <strong>Pagar</strong> para abonar.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>3. Inventario de Productos</h3>
        <p>Visualiza todos los productos con su precio y stock. El stock se actualiza con cada venta.</p>

        <h4>3.1 Agregar Producto</h4>
        <ul>
            <li>Si el producto <strong>ya existe</strong>, solo se suma stock. Precio no es obligatorio.</li>
            <li>Si el producto <strong>es nuevo</strong>, completa nombre, precio y stock.</li>
        </ul>

        <h4>3.2 Editar o Eliminar</h4>
        <ul>
            <li>Usa el menú <code>...</code> junto al producto.</li>
            <li>"Editar" permite modificar nombre, precio y stock.</li>
            <li>"Borrar" elimina el producto permanentemente.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>4. Cuentas por Cobrar</h3>
        <p>Muestra todos los clientes con ventas pendientes. Haz clic en el nombre del cliente para ver detalles de las deudas.</p>

        <ul>
            <li>Visualiza <strong>total adeudado</strong> y detalle por venta.</li>
            <li>Te permite dar seguimiento y contactar clientes fácilmente.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>5. Preguntas Frecuentes (FAQ)</h3>
        <ul>
            <li><strong>¿Qué pasa si ingreso mal un dato?</strong> Puedes editar clientes o productos desde la hoja de cálculo.</li>
            <li><strong>¿Se guarda automáticamente?</strong> Sí, cada acción actualiza las hojas correspondientes.</li>
            <li><strong>¿Puedo usarlo en celular?</strong> Sí, es 100% responsive y funciona en dispositivos móviles.</li>
        </ul>
    </div>

    <div class="manual-section">
        <h3>Soporte Técnico</h3>
        <p>¿Tienes preguntas o necesitas ayuda?</p>
        <ul>
            <li><strong>WhatsApp:</strong> <a href="https://wa.me/5549991839170" target="_blank">+55 49 99183-9170</a></li>
            <li><strong>Email:</strong> <a href="mailto:aeinformatica7@gmail.com">aeinformatica7@gmail.com</a></li>
        </ul>
        <p>Con gusto te atenderé. 😊</p>
    </div>
</div>


<div class="container">
    <div class="tab-menu" id="tab-menu">
        <button class="tab-button active" id="tab-client" onclick="openTab('clientTab', this)">Registrar Cliente</button>
        <button class="tab-button" id="tab-search" onclick="openTab('searchTab', this)">Buscar Cliente & Ventas</button>
        <button class="tab-button" id="tab-inventory" onclick="openTab('inventoryTab', this)">Inventario</button>
        <button class="tab-button" id="tab-debt" onclick="openTab('debtTab', this)">Cuentas por Cobrar</button>
    </div>

    <div id="clientTab" class="tab-content active">
        <div class="form-container">
            <h2>Registro de Clientes</h2>
            <form id="customerForm">
                <input type="hidden" name="action" value="addClient">
                <div class="form-group">
                    <label for="Nome">Nombre</label>
                    <input type="text" id="Nome" name="Nome" required>
                </div>
                <div class="form-group">
                    <label for="CPF/CNPJ">CPF/CNPJ</label>
                    <input type="text" id="CPF/CNPJ" name="CPF/CNPJ" required>
                </div>
                <div class="form-group">
                    <label for="Email">Email</label>
                    <input type="email" id="Email" name="Email" required>
                </div>
                <div class="form-group">
                    <label for="Telefono">Teléfono</label>
                    <input type="text" id="Telefono" name="Telefono">
                </div>
                <div class="form-group">
                    <label for="Direccion">Dirección</label>
                    <input type="text" id="Direccion" name="Direccion">
                </div>
                <div class="form-group">
                    <label for="Fecha">Fecha</label>
                    <input type="date" id="Fecha" name="Fecha" required>
                </div>
                <button type="submit" class="btn-submit">Guardar Cliente</button>
                <p id="form-message" class="form-message"></p>
            </form>
        </div>
    </div>

    <div id="searchTab" class="tab-content">
        <div class="form-container">
            <h2>Buscar Cliente y Registrar Venta</h2>
            <form id="searchForm">
                <div class="form-group" id="search-cpf-container">
                    <label for="search-cpf">Buscar por CPF/CNPJ</label>
                    <input type="text" id="search-cpf" name="CPF/CNPJ" required>
                </div>
                <button type="submit" class="btn-submit">Buscar</button>
                <p id="search-message" class="form-message"></p>
            </form>
            <div id="results-container"></div>
        </div>
    </div>

    <div id="inventoryTab" class="tab-content">
        <div class="form-container">
            <h2>Inventario de Productos</h2>
            <div id="inventory-list">
                <p>Cargando inventario...</p>
            </div>
            
            <div class="inventory-form-section" id="addProductSection">
                <form id="addProductForm">
                    <h3 style="color: #8e24aa;">Agregar Nuevo Producto</h3>
                    
                    <div class="form-group">
                        <label for="product-name">Nombre del Producto</label>
                        <input type="text" id="product-name" name="Nombre_del_producto" required>
                    </div>

                    <div class="form-group">
                        <label for="product-price">Precio</label>
                        <input type="number" id="product-price" name="Precio" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="product-stock">Stock a añadir</label>
                        <input type="number" id="product-stock" name="Stock" min="0" required>
                    </div>
                    <button type="submit" class="btn-submit">Agregar Producto</button>
                    <p id="add-product-message" class="form-message"></p>
                </form>
            </div>
            
            <div class="inventory-form-section" id="editProductSection" style="display:none;">
                <form id="editProductForm">
                    <h3 style="color: #8e24aa;">Editar Producto</h3>
                    <input type="hidden" id="edit-product-id" name="ID_Producto">
                    
                    <div class="form-group">
                        <label for="edit-product-name">Nombre del Producto</label>
                        <input type="text" id="edit-product-name" name="Nombre_del_producto" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-product-price">Precio</label>
                        <input type="number" id="edit-product-price" name="Precio" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-product-stock">Stock a modificar (se sumará al stock actual)</label>
                        <input type="number" id="edit-product-stock" name="Stock" required>
                    </div>
                    <button type="submit" class="btn-submit">Guardar Cambios</button>
                    <button type="button" class="btn-submit" onclick="cancelEdit()">Cancelar</button>
                    <p id="edit-product-message" class="form-message"></p>
                </form>
            </div>

        </div>
    </div>

    <div id="debtTab" class="tab-content">
        <div class="form-container">
            <h2>Cuentas por Cobrar</h2>
            <div id="debt-list">
                <p>Cargando cuentas pendientes...</p>
            </div>
        </div>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbybxe6Iu6rlXzk6_rQLkirk2Vi1couqQ8nFhFh8nSmJ_4bWZarpn5WxVDTLAbKLcMLL/exec'; 

    let allProducts = [];
    let salesProducts = [];

    function showLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }

    async function loadApp() {
        try {
            openTab('clientTab', document.getElementById('tab-client'));
            
            await fetchProducts();
            
        } catch (error) {
            console.error("Error al cargar la aplicación:", error);
            alert("Hubo un problema al cargar la aplicación. Por favor, recarga la página. Mensaje: " + error.message);
        }
    }

    async function fetchProducts() {
        showLoading();
        try {
            const productsResponse = await fetch(scriptURL + '?action=getProducts');
            if (!productsResponse.ok) throw new Error('Error al obtener los productos.');
            allProducts = await productsResponse.json();
        } catch (error) {
            console.error("Error al cargar los productos:", error);
            allProducts = []; // Asegura que allProducts sea un array vacío si falla
        } finally {
            hideLoading();
        }
    }
    
    function openTab(tabName, button) {
        var i, tabContent, tabButtons;
        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
        }
        tabButtons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabButtons.length; i++) {
            tabButtons[i].className = tabButtons[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        if (button) {
            button.className += " active";
        }
        if (tabName === 'inventoryTab') {
            loadInventory();
            document.getElementById('addProductSection').style.display = 'block';
            document.getElementById('editProductSection').style.display = 'none';
        } else if (tabName === 'debtTab') {
            loadPendingSales();
        }
    }

    async function loadInventory() {
        const inventoryList = document.getElementById('inventory-list');
        
        inventoryList.innerHTML = '<p>Cargando inventario...</p>';
        
        await fetchProducts();

        if (allProducts.length > 0) {
            let html = '<table class="inventory-table">';
            html += '<thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th></th></tr></thead>';
            html += '<tbody>';
            allProducts.forEach(product => {
                html += `<tr>
                           <td>${product['ID_Producto']}</td>
                           <td>${product['Nombre_del_producto']}</td>
                           <td>R$ ${product.Precio.toFixed(2)}</td>
                           <td>${product.Stock}</td>
                           <td>
                                <div class="dropdown">
                                    <button class="dropbtn">...</button>
                                    <div class="dropdown-content">
                                        <a href="#" onclick="editProduct('${product['ID_Producto']}', '${product['Nombre_del_producto']}', '${product.Precio}', '${product.Stock}')">Editar</a>
                                        <a href="#" onclick="deleteProduct('${product['ID_Producto']}')">Borrar</a>
                                    </div>
                                </div>
                           </td>
                         </tr>`;
            });
            html += '</tbody></table>';
            inventoryList.innerHTML = html;
        } else {
            inventoryList.innerHTML = '<p>No hay productos en el inventario.</p>';
        }
    }
    
    function editProduct(id, name, price, stock) {
        document.getElementById('addProductSection').style.display = 'none';
        document.getElementById('editProductSection').style.display = 'block';
        
        document.getElementById('edit-product-id').value = id;
        document.getElementById('edit-product-name').value = name;
        document.getElementById('edit-product-price').value = price;
        document.getElementById('edit-product-stock').value = 0;
    }
    
    function cancelEdit() {
        document.getElementById('editProductForm').reset();
        document.getElementById('addProductSection').style.display = 'block';
        document.getElementById('editProductSection').style.display = 'none';
    }
    
    async function deleteProduct(id) {
        if (!confirm('¿Estás seguro de que quieres borrar este producto? Esta acción es irreversible.')) {
            return;
        }
        
        showLoading();
        try {
            const formData = new FormData();
            formData.append('action', 'deleteProduct');
            formData.append('ID_Producto', id);
            
            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();
            
            if (response.ok) {
                if (resultText.includes("Error")) {
                    alert(resultText);
                } else {
                    alert('Producto eliminado con éxito.');
                    loadInventory();
                }
            } else {
                alert('Error al procesar la solicitud.');
            }
        } catch (error) {
            alert('Hubo un problema de conexión.');
        } finally {
            hideLoading();
        }
    }

    async function loadPendingSales() {
        const debtList = document.getElementById('debt-list');
        debtList.innerHTML = '<p>Cargando cuentas pendientes...</p>';
        showLoading();
        try {
            const response = await fetch(scriptURL + '?action=getPendingSales');
            const groupedSales = await response.json();
            if (groupedSales.length > 0) {
                let html = '<h3>Deuda Total por Cliente</h3>';
                groupedSales.forEach((clientDebt, index) => {
                    html += `
                        <div class="debt-client-header" onclick="toggleDebtDetails('debt-details-${index}')">
                            <h4>${clientDebt.nombreCliente}</h4>
                            <span>Deuda Total: R$ ${clientDebt.deudaTotal.toFixed(2)}</span>
                        </div>
                        <div class="debt-details" id="debt-details-${index}">
                            ${clientDebt.ventas.map(sale => `
                                <p><strong>ID Venta:</strong> ${sale.id} | <strong>Fecha:</strong> ${new Date(sale.fecha).toLocaleDateString()} | <strong>Deuda:</strong> R$ ${sale.deudaRestante.toFixed(2)}</p>
                            `).join('')}
                        </div>
                    `;
                });
                debtList.innerHTML = html;
            } else {
                debtList.innerHTML = '<p>No hay cuentas pendientes en este momento.</p>';
            }
        } catch (error) {
            console.error("Error al cargar las cuentas pendientes:", error);
            debtList.innerHTML = '<p>Error al cargar las cuentas pendientes. Asegúrate de que las columnas en tu hoja "Ventas" están escritas correctamente.</p>';
        } finally {
            hideLoading();
        }
    }
    
    function toggleDebtDetails(detailsId) {
        const details = document.getElementById(detailsId);
        if (details.style.display === 'block') {
            details.style.display = 'none';
        } else {
            details.style.display = 'block';
        }
    }

    if (document.getElementById('customerForm')) {
      const customerForm = document.getElementById('customerForm');
      const customerMessage = document.getElementById('form-message');
      customerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          customerMessage.textContent = 'Enviando...';
          customerMessage.className = 'form-message';
          showLoading();
          try {
              const formData = new FormData(customerForm);
              const response = await fetch(scriptURL, { method: 'POST', body: formData });
              const resultText = await response.text();
              if (response.ok) {
                  if (resultText.includes("Error")) {
                      customerMessage.textContent = resultText;
                      customerMessage.className = 'form-message error';
                  } else {
                      customerMessage.textContent = '¡Cliente registrado con éxito!';
                      customerMessage.className = 'form-message success';
                      customerForm.reset();
                  }
              } else {
                  customerMessage.textContent = 'Error al registrar el cliente.';
                  customerMessage.className = 'form-message error';
              }
          } catch (error) {
              customerMessage.textContent = 'Hubo un problema de conexión.';
              customerMessage.className = 'form-message error';
          } finally {
              hideLoading();
          }
      });
    }

    const searchForm = document.getElementById('searchForm');
    const searchMessage = document.getElementById('search-message');
    const resultsContainer = document.getElementById('results-container');

    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        resultsContainer.innerHTML = '';
        searchMessage.textContent = 'Buscando...';
        searchMessage.className = 'form-message';
        showLoading();
        const searchCpfCnpj = document.getElementById('search-cpf').value;

        try {
            const url = scriptURL + '?action=search&CPF/CNPJ=' + searchCpfCnpj;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data && data.Nome) {
                searchMessage.textContent = 'Cliente encontrado:';
                searchMessage.className = 'form-message success';
                
                let salesHtml = data.sales.length > 0
                    ? `<h4>Historial de Ventas:</h4>
                       <ul>
                           ${data.sales.map(sale => `
                               <li class="sale-item ${sale.estado === 'Pagado' ? 'paid' : 'pending'}">
                                   <p><span class="result-label">ID Venta:</span> ${sale.id} | 
                                   <span class="result-label">Monto Total:</span> R$ ${sale.montoTotal.toFixed(2)} | 
                                   <span class="result-label">Pagado:</span> R$ ${sale.montoPagado.toFixed(2)} | 
                                   <span class="result-label">Deuda:</span> R$ ${sale.deudaRestante.toFixed(2)}</p>
                                   <p><span class="result-label">Fecha:</span> ${new Date(sale.fecha).toLocaleDateString()}
                                   <button onclick="toggleSaleDetails(this)">+</button>
                                   ${sale.estado === 'Pendiente' ? `<button class="btn-pay" onclick="showPaymentForm(${sale.id}, ${sale.deudaRestante})">Pagar</button>` : `<span style="color:#4CAF50; font-weight:bold;">(${sale.estado})</span>`}</p>
                                   
                                   <div class="sale-details" style="display:none;">
                                        <ul>
                                            ${sale.productos.map(p => `<li>${p.nombre} (${p.cantidad} unidad/es)</li>`).join('')}
                                        </ul>
                                   </div>
                               </li>
                           `).join('')}
                       </ul>`
                    : `<p>Este cliente no tiene ventas registradas.</p>`;

                resultsContainer.innerHTML = `
                    <p><span class="result-label">Nombre:</span> ${data.Nome}</p>
                    <p><span class="result-label">CPF/CNPJ:</span> ${data['CPF/CNPJ']}</p>
                    <p><span class="result-label">Email:</span> ${data.Email}</p>
                    <p><span class="result-label">Teléfono:</span> ${data.Telefono || 'N/A'}</p>
                    <p><span class="result-label">Dirección:</span> ${data.Direccion || 'N/A'}</p>
                    <p><span class="result-label">Fecha de Registro:</span> ${new Date(data.Fecha).toLocaleDateString()}</p>
                    <hr>
                    <p class="total-debt-info"><strong>Deuda Total Pendiente: R$ ${data.totalDebt}</strong></p>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="color: #8e24aa;">Registrar Nueva Venta para ${data.Nome}</h3>
                        <form id="saleForm">
                            <input type="hidden" name="action" value="addSale">
                            <input type="hidden" name="CPF/CNPJ" value="${data['CPF/CNPJ']}">
                            <input type="hidden" id="productsJson" name="Productos">
                            <input type="hidden" id="totalAmount" name="MontoTotal">
                            
                            <div class="form-group">
                                <label for="sale-fecha">Fecha de Venta</label>
                                <input type="date" id="sale-fecha" name="Fecha" required>
                            </div>
                            <div id="products-list"></div>
                            <div style="text-align: right;">
                                <button type="button" onclick="addProductField()" class="btn-add">+</button>
                            </div>
                            <div class="form-group" style="margin-top: 20px;">
                                <label for="initialPayment">Abono Inicial (opcional)</label>
                                <input type="number" id="initialPayment" name="Monto_Pagado" step="0.01" min="0">
                            </div>
                            <br>
                            <button type="submit" class="btn-submit">Guardar Venta</button>
                            <p id="sale-message" class="form-message"></p>
                        </form>
                    </div>

                    ${salesHtml}
                `;
                salesProducts = [];
                addProductField();
                const saleForm = document.getElementById('saleForm');
                const saleMessage = document.getElementById('sale-message');
                saleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    saleMessage.textContent = 'Calculando y enviando...';
                    saleMessage.className = 'form-message';
                    showLoading();
                    
                    let total = 0;
                    const finalProducts = [];
                    salesProducts.forEach(p => {
                        const product = allProducts.find(prod => prod.ID_Producto == p.id);
                        if (product) {
                            total += product.Precio * p.cantidad;
                            finalProducts.push({
                                id: product.ID_Producto,
                                nombre: product.Nombre_del_producto,
                                cantidad: p.cantidad
                            });
                        }
                    });

                    document.getElementById('totalAmount').value = total;
                    document.getElementById('productsJson').value = JSON.stringify(finalProducts);

                    try {
                        const formData = new FormData(saleForm);
                        const response = await fetch(scriptURL, { method: 'POST', body: formData });
                        const resultText = await response.text();
                        if (response.ok) {
                            if (resultText.includes("Error")) {
                                saleMessage.textContent = resultText;
                                saleMessage.className = 'form-message error';
                            } else {
                                saleMessage.textContent = '¡Venta registrada con éxito!';
                                saleMessage.className = 'form-message success';
                                saleForm.reset();
                                salesProducts = [];
                                resultsContainer.innerHTML = '';
                                searchForm.dispatchEvent(new Event('submit'));
                            }
                        } else {
                            saleMessage.textContent = 'Error al registrar la venta.';
                            saleMessage.className = 'form-message error';
                        }
                    } catch (error) {
                        saleMessage.textContent = 'Hubo un problema de conexión.';
                        saleMessage.className = 'form-message error';
                    } finally {
                        hideLoading();
                    }
                });
                
            } else {
                searchMessage.textContent = 'No se encontró ningún cliente con ese CPF/CNPJ.';
                searchMessage.className = 'form-message error';
            }
        } catch (error) {
            searchMessage.textContent = 'Hubo un problema en la búsqueda: ' + error.message;
            searchMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
    });
    
    async function handlePayment(saleId, paymentAmount) {
        const paymentMessage = document.getElementById(`payment-message-${saleId}`);
        paymentMessage.textContent = 'Registrando pago...';
        paymentMessage.className = 'form-message';
        showLoading();
        try {
            const formData = new FormData();
            formData.append('action', 'addPayment');
            formData.append('ID_Transaccion', saleId);
            formData.append('Monto_Pago', paymentAmount);

            const response = await fetch(scriptURL, { method: 'POST', body: formData });
            const resultText = await response.text();
            if (response.ok) {
                if (resultText.includes("Error")) {
                    paymentMessage.textContent = resultText;
                    paymentMessage.className = 'form-message error';
                } else {
                    paymentMessage.textContent = '¡Pago registrado con éxito!';
                    paymentMessage.className = 'form-message success';
                    searchForm.dispatchEvent(new Event('submit'));
                }
            } else {
                paymentMessage.textContent = 'Error al registrar el pago.';
                paymentMessage.className = 'form-message error';
            }
        } catch (error) {
            paymentMessage.textContent = 'Hubo un problema de conexión.';
            paymentMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
    }

    function showPaymentForm(saleId, currentDebt) {
        const formId = `payment-form-${saleId}`;
        const existingForm = document.getElementById(formId);
        if (existingForm) {
            existingForm.remove();
            return;
        }

        const paymentForm = document.createElement('form');
        paymentForm.id = formId;
        paymentForm.className = 'sale-details-form';
        paymentForm.onsubmit = (e) => {
            e.preventDefault();
            const amountInput = paymentForm.querySelector('input');
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0 || amount > currentDebt) {
                alert(`El monto debe ser un número positivo y no mayor a la deuda restante de R$ ${currentDebt.toFixed(2)}.`);
                return;
            }
            handlePayment(saleId, amount);
        };
        
        paymentForm.innerHTML = `
            <div class="form-group">
                <label for="payment-amount-${saleId}">Monto a pagar (Deuda: R$ ${currentDebt.toFixed(2)})</label>
                <input type="number" id="payment-amount-${saleId}" step="0.01" min="0.01" max="${currentDebt}" required>
            </div>
            <button type="submit" class="btn-submit">Registrar Abono</button>
            <p id="payment-message-${saleId}" class="form-message"></p>
        `;

        const saleItem = document.querySelector(`.sale-item .btn-pay[onclick*="${saleId}"]`).closest('.sale-item');
        saleItem.appendChild(paymentForm);
    }
    
    function addProductField() {
        const productsListDiv = document.getElementById('products-list');
        const index = salesProducts.length;

        const productSelect = document.createElement('select');
        productSelect.innerHTML = allProducts.map(p => 
            `<option value="${p.ID_Producto}" data-price="${p.Precio}" data-stock="${p.Stock}">${p.Nombre_del_producto} (Stock: ${p.Stock})</option>`
        ).join('');
        productSelect.onchange = (e) => updateProduct(index, e.target.value, salesProducts[index].cantidad);

        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.value = 1;
        quantityInput.min = 1;
        quantityInput.onchange = (e) => updateProduct(index, salesProducts[index].id, parseInt(e.target.value));
        quantityInput.style.width = '80px';
        
        const removeButton = document.createElement('button');
        removeButton.textContent = '-';
        removeButton.type = 'button';
        removeButton.className = 'btn-remove';
        removeButton.onclick = () => removeProductField(index);

        const productItem = document.createElement('div');
        productItem.className = 'product-item';
        productItem.id = `product-item-${index}`;
        productItem.appendChild(productSelect);
        productItem.appendChild(quantityInput);
        productItem.appendChild(removeButton);
        productsListDiv.appendChild(productItem);

        if (allProducts.length > 0) {
            salesProducts.push({
                id: allProducts[0].ID_Producto,
                cantidad: 1
            });
        }
    }

    function updateProduct(index, productId, quantity) {
        salesProducts[index].id = productId;
        salesProducts[index].cantidad = quantity;
    }

    function removeProductField(index) {
        const element = document.getElementById(`product-item-${index}`);
        if (element) {
            element.remove();
        }
        salesProducts.splice(index, 1);

        const productsListDiv = document.getElementById('products-list');
        productsListDiv.innerHTML = '';
        salesProducts.forEach((p, i) => {
            const productSelect = document.createElement('select');
            productSelect.innerHTML = allProducts.map(prod => 
                `<option value="${prod.ID_Producto}" data-price="${prod.Precio}" data-stock="${prod.Stock}">${prod.Nombre_del_producto} (Stock: ${prod.Stock})</option>`
            ).join('');
            productSelect.value = p.id;
            productSelect.onchange = (e) => updateProduct(i, e.target.value, salesProducts[i].cantidad);

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.value = p.cantidad;
            quantityInput.min = 1;
            quantityInput.onchange = (e) => updateProduct(i, salesProducts[i].id, parseInt(e.target.value));
            quantityInput.style.width = '80px';
            
            const removeButton = document.createElement('button');
            removeButton.textContent = '-';
            removeButton.type = 'button';
            removeButton.className = 'btn-remove';
            removeButton.onclick = () => removeProductField(i);

            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.id = `product-item-${i}`;
            productItem.appendChild(productSelect);
            productItem.appendChild(quantityInput);
            productItem.appendChild(removeButton);
            productsListDiv.appendChild(productItem);
        });
    }

    function toggleSaleDetails(button) {
        const saleItem = button.closest('.sale-item');
        if (saleItem) {
            const details = saleItem.querySelector('.sale-details');
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        }
    }

    const addProductForm = document.getElementById('addProductForm');
    const addProductMessage = document.getElementById('add-product-message');
    if (addProductForm) {
      addProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        addProductMessage.textContent = 'Enviando...';
        addProductMessage.className = 'form-message';
        showLoading();
        
        const productName = document.getElementById('product-name').value;
        const productPrice = document.getElementById('product-price').value;
        const productStock = document.getElementById('product-stock').value;

        if (!productName.trim()) {
            addProductMessage.textContent = 'El nombre del producto es obligatorio.';
            addProductMessage.className = 'form-message error';
            hideLoading();
            return;
        }
        if (!productStock || parseInt(productStock) <= 0) {
            addProductMessage.textContent = 'La cantidad a añadir debe ser un número positivo.';
            addProductMessage.className = 'form-message error';
            hideLoading();
            return;
        }

        const formData = new FormData();
        formData.append('action', 'addProduct');
        formData.append('Nombre_del_producto', productName);
        formData.append('Precio', productPrice);
        formData.append('Stock', productStock);
        

        try {
          const response = await fetch(scriptURL, { method: 'POST', body: formData });
          const resultText = await response.text();
          if (response.ok) {
            if (resultText.includes("Error")) {
              addProductMessage.textContent = resultText;
              addProductMessage.className = 'form-message error';
            } else {
              addProductMessage.textContent = '¡Operación exitosa!';
              addProductMessage.className = 'form-message success';
              addProductForm.reset();
              loadInventory();
            }
          } else {
            addProductMessage.textContent = 'Error al procesar la solicitud.';
            addProductMessage.className = 'form-message error';
          }
        } catch (error) {
          addProductMessage.textContent = 'Hubo un problema de conexión.';
          addProductMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
      });
    }
    
    const editProductForm = document.getElementById('editProductForm');
    const editProductMessage = document.getElementById('edit-product-message');
    if (editProductForm) {
      editProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        editProductMessage.textContent = 'Enviando...';
        editProductMessage.className = 'form-message';
        showLoading();
        
        const productId = document.getElementById('edit-product-id').value;
        const productName = document.getElementById('edit-product-name').value;
        const productPrice = document.getElementById('edit-product-price').value;
        const productStock = document.getElementById('edit-product-stock').value;

        const formData = new FormData();
        formData.append('action', 'updateProduct');
        formData.append('ID_Producto', productId);
        formData.append('Nombre_del_producto', productName);
        formData.append('Precio', productPrice);
        formData.append('Stock', productStock);
        

        try {
          const response = await fetch(scriptURL, { method: 'POST', body: formData });
          const resultText = await response.text();
          if (response.ok) {
            if (resultText.includes("Error")) {
              editProductMessage.textContent = resultText;
              editProductMessage.className = 'form-message error';
            } else {
              editProductMessage.textContent = '¡Operación exitosa!';
              editProductMessage.className = 'form-message success';
              editProductForm.reset();
              loadInventory();
              cancelEdit();
            }
          } else {
            editProductMessage.textContent = 'Error al procesar la solicitud.';
            editProductMessage.className = 'form-message error';
          }
        } catch (error) {
          editProductMessage.textContent = 'Hubo un problema de conexión.';
          editProductMessage.className = 'form-message error';
        } finally {
            hideLoading();
        }
      });
    }

    function toggleManual() {
        const manualContent = document.getElementById('user-manual-content');
        if (manualContent.style.display === 'block') {
            manualContent.style.display = 'none';
        } else {
            manualContent.style.display = 'block';
        }
    }
    
    document.addEventListener('DOMContentLoaded', loadApp);
</script>
</body>
</html>